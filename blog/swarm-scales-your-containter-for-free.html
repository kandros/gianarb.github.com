<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Swarm scales docker for free</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Docker is an awesome tool to manage your container. Swarm helps you to scale your containers on more servers.">
    <meta name="keywords" content="devops, docker">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/swarm-scales-your-containter-for-free">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="Swarm scales docker for free">
    <meta name='twitter:description' content="Docker is an awesome tool to manage your container. Swarm helps you to scale your containers on more servers.">

    <meta property="og:title" content="Swarm scales docker for free" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/swarm-scales-your-containter-for-free" />
    <meta property="og:description" content="Docker is an awesome tool to manage your container. Swarm helps you to scale your containers on more servers." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:image" content="https://gianarb.it/img/docker.png" />
    <meta name='twitter:image' content="https://gianarb.it/img/docker.png">



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="Swarm scales docker for free">
    <meta name="twitter:description" content="Docker is an awesome tool to manage your container. Swarm helps you to scale your containers on more servers.">
    <meta name="twitter:image:src" content="https://gianarb.it/img/docker.png">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>Swarm scales docker for free</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">14 Dec 2015 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Six minute read</span>
 · devops, docker</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <blockquote class="twitter-tweet tw-align-center" data-lang="en"><p lang="en" dir="ltr">An ocean of containers! With docker and swarm.. <a href="https://t.co/1dXoZYS3ZA">https://t.co/1dXoZYS3ZA</a> <a href="https://twitter.com/hashtag/docker?src=hash">#docker</a></p>&mdash; Gianluca Arbezzano (@GianArb) <a href="https://twitter.com/GianArb/status/696620821931036672">February 8, 2016</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p><a href="https://github.com/gianarb/gourmet">Gourmet</a> is a work in progress application
that allow you to execute little applications on an isolated environment, it
dowloads your manifest and runs it in a container.
I start this application to improve my go knowledge and to work with the Docker API
I am happy to share my idea and my tests with Swam an easy way to scale this type of application.</p>

<p>Gourmet exposes an HTTP API available at the <code class="highlighter-rouge">/project</code> endpoint that accept a JSON request body like:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="s2">"img"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gourmet/php"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://ramdom-your-source.net/gourmet.zip"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"env"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"AWS_KEY=EXAMPLE"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"AWS_SECRET="</span><span class="p">,</span><span class="w">
        </span><span class="s2">"AWS_QUEUE=https://sqs.eu-west-1.amazonaws.com/test"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">img</code> is the started point docker image</li>
  <li><code class="highlighter-rouge">source</code> is your script</li>
  <li><code class="highlighter-rouge">env</code> is a list of environment variables that you can use on your script</li>
</ul>

<p>During my test I use this <a href="https://github.com/gianarb/gourmet-php-example">php script</a> that send a message on SQS.</p>

<p>Your script has a console entrypoint executables in this path <code class="highlighter-rouge">/bin/console</code> and
gourmet uses it to run your program.</p>

<p>To integrate it with Docker I used <code class="highlighter-rouge">fsouza/go-dockerclient</code> an open source
library written in go.</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="n">container</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">dr</span><span class="o">.</span><span class="n">Docker</span><span class="o">.</span><span class="n">CreateContainer</span><span class="p">(</span><span class="n">docker</span><span class="o">.</span><span class="n">CreateContainerOptions</span><span class="p">{</span><span class="x">
    </span><span class="s">""</span><span class="p">,</span><span class="x">
    </span><span class="o">&amp;</span><span class="n">docker</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span><span class="x">
        </span><span class="n">Image</span><span class="o">:</span><span class="x">        </span><span class="n">img</span><span class="p">,</span><span class="x">
        </span><span class="n">Cmd</span><span class="o">:</span><span class="x">          </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"sleep"</span><span class="p">,</span><span class="x"> </span><span class="s">"1000"</span><span class="p">},</span><span class="x">
        </span><span class="n">WorkingDir</span><span class="o">:</span><span class="x">   </span><span class="s">"/tmp"</span><span class="p">,</span><span class="x">
        </span><span class="n">AttachStdout</span><span class="o">:</span><span class="x"> </span><span class="no">false</span><span class="p">,</span><span class="x">
        </span><span class="n">AttachStderr</span><span class="o">:</span><span class="x"> </span><span class="no">false</span><span class="p">,</span><span class="x">
        </span><span class="n">Env</span><span class="o">:</span><span class="x">          </span><span class="n">envVars</span><span class="p">,</span><span class="x">
    </span><span class="p">},</span><span class="x">
    </span><span class="no">nil</span><span class="p">,</span><span class="x">
</span><span class="p">})</span></code></pre></figure>

<p>This is a snippet that can be used to create a new container.
With the container started I use the exec feature to
extract your source and to run it.</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="n">exec</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">dr</span><span class="o">.</span><span class="n">Docker</span><span class="o">.</span><span class="n">CreateExec</span><span class="p">(</span><span class="n">docker</span><span class="o">.</span><span class="n">CreateExecOptions</span><span class="p">{</span><span class="x">
    </span><span class="n">Container</span><span class="o">:</span><span class="x">    </span><span class="n">containerId</span><span class="p">,</span><span class="x">
    </span><span class="n">AttachStdin</span><span class="o">:</span><span class="x">  </span><span class="no">true</span><span class="p">,</span><span class="x">
    </span><span class="n">AttachStdout</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
    </span><span class="n">AttachStderr</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
    </span><span class="n">Tty</span><span class="o">:</span><span class="x">          </span><span class="no">false</span><span class="p">,</span><span class="x">
    </span><span class="n">Cmd</span><span class="o">:</span><span class="x">          </span><span class="n">command</span><span class="p">,</span><span class="x">
</span><span class="p">})</span><span class="x">

</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="p">;</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">dr</span><span class="o">.</span><span class="n">Docker</span><span class="o">.</span><span class="n">StartExec</span><span class="p">(</span><span class="n">exec</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span><span class="x"> </span><span class="n">docker</span><span class="o">.</span><span class="n">StartExecOptions</span><span class="p">{</span><span class="x">
    </span><span class="n">Detach</span><span class="o">:</span><span class="x">      </span><span class="no">false</span><span class="p">,</span><span class="x">
    </span><span class="n">Tty</span><span class="o">:</span><span class="x">         </span><span class="no">false</span><span class="p">,</span><span class="x">
    </span><span class="n">RawTerminal</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x">
    </span><span class="n">OutputStream</span><span class="o">:</span><span class="x"> </span><span class="n">dr</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span><span class="x">
    </span><span class="n">ErrorStream</span><span class="o">:</span><span class="x">  </span><span class="n">dr</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span><span class="x">
</span><span class="p">})</span></code></pre></figure>

<p>After each build Gourmet cleans all and destroies the environment.</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">dr</span><span class="o">.</span><span class="n">Docker</span><span class="o">.</span><span class="n">KillContainer</span><span class="p">(</span><span class="n">docker</span><span class="o">.</span><span class="n">KillContainerOptions</span><span class="p">{</span><span class="n">ID</span><span class="o">:</span><span class="x"> </span><span class="n">containerId</span><span class="p">})</span><span class="x">
</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">dr</span><span class="o">.</span><span class="n">Docker</span><span class="o">.</span><span class="n">RemoveContainer</span><span class="p">(</span><span class="n">docker</span><span class="o">.</span><span class="n">RemoveContainerOptions</span><span class="p">{</span><span class="n">ID</span><span class="o">:</span><span class="x"> </span><span class="n">containerId</span><span class="p">,</span><span class="x"> </span><span class="n">RemoveVolumes</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">})</span><span class="x">
</span><span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="p">;</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span></code></pre></figure>

<p>At the moment it is gourmet, It could be different hypothetical use cases:</p>

<ul>
  <li>high separated task</li>
  <li>run a testsuite</li>
  <li>dispatch specific functions</li>
</ul>

<p>A microservice to work with docker container easily.</p>

<p>I thought about an easy way to scale this application and I found
<a href="https://docs.docker.com/swarm/">Swarm</a>, it is a native cluster for docker and
it seems awesome in first because  it is compatibile with the docker api.</p>

<h2 id="swarm">Swarm</h2>
<p>A Docker Swarm’s cluster is very easy to setup, I worked on this project
<a href="https://github.com/gianarb/vagrant-swarm">vagrant-swarm</a> to create a local
environment but <a href="https://docs.docker.com/swarm/install-manual/">the official
documentation</a> is easy to follow.</p>

<p>Swarm’s cluster has two actors:</p>
<ul>
  <li>A master is the entrypoint of your requests, it provide an HTTP
api compatible with docker.</li>
  <li>A series of nodes that communicate with the master.</li>
</ul>

<p>During this example we will work with 1 master and 2 nodes.
Build this machine with virtualbox , with another tool, or in cloud is not a
problem and <a href="https://docs.docker.com/engine/installation/">install docker</a>.</p>

<p>Into the master pull swarm and create a cluster identifier.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker pull swarm
docker run <span class="nt">--rm</span> swarm create
docker run <span class="nt">--name</span> swarm_master <span class="nt">-d</span> <span class="nt">-p</span> &lt;manager_port&gt;:2375 swarm manage token://&lt;cluster_id&gt;</code></pre></figure>

<p><code class="highlighter-rouge">swarm create</code> returns a cluster_id use them to start the manager and the
<code class="highlighter-rouge">manager_ip</code> is the ip of your master server.</p>

<p>Now go into the node, because we must do few things.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker daemon <span class="nt">-H</span> tcp://0.0.0.0:2375 <span class="nt">-H</span> unix:///var/run/docker.sock
docker run <span class="nt">-d</span> swarm join <span class="nt">--addr</span><span class="o">=</span>&lt;node_ip:2375&gt; token://&lt;cluster_id&gt;</code></pre></figure>

<p>When <code class="highlighter-rouge">cluster_id</code> is the id created in the previous step and the <code class="highlighter-rouge">node_id</code> is the ip
of  your current node.
Enter into the master and restart your manager container</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker restart swarm_master</code></pre></figure>

<p>Now we are ready to test if all it’s up.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker <span class="nt">-H</span> tcp://0.0.0.0:2375 info</code></pre></figure>

<p>Replace <code class="highlighter-rouge">0.0.0.0.0</code> with your master ip if you are in the same server.
You’ll wait this type of response</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$.</span> <span class="nb">sudo </span>docker <span class="nt">-H</span> tcp://192.168.13.1:2375 info
Containers: 1
Images: 1
Role: primary
Strategy: spread
Filters: health, port, dependency, affinity, constraint
Nodes: 2
 vagrant-ubuntu-vivid-64: 192.168.13.101:2375
  └ Status: Healthy
  └ Containers: 1
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 513.5 MiB
  └ Labels: <span class="nv">executiondriver</span><span class="o">=</span>native-0.2, <span class="nv">kernelversion</span><span class="o">=</span>3.19.0-43-generic, <span class="nv">operatingsystem</span><span class="o">=</span>Ubuntu 15.04, <span class="nv">storagedriver</span><span class="o">=</span>aufs
 vagrant-ubuntu-vivid-64: 192.168.13.102:2375
  └ Status: Healthy
  └ Containers: 0
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 513.5 MiB
  └ Labels: <span class="nv">executiondriver</span><span class="o">=</span>native-0.2, <span class="nv">kernelversion</span><span class="o">=</span>3.19.0-43-generic, <span class="nv">operatingsystem</span><span class="o">=</span>Ubuntu 15.04, <span class="nv">storagedriver</span><span class="o">=</span>aufs
CPUs: 1
Total Memory: 513.5 MiB
Name: f5e23167339e</code></pre></figure>

<p>Gourmet is a set of environment variables to create a connection with docker
api, in particular this function
<a href="https://godoc.org/github.com/fsouza/go-dockerclient#NewClientFromEnv">NewClientFromEnv</a>
and the <code class="highlighter-rouge">DOCKER_HOST</code> parameter.</p>

<p>Docker Swarm supports the same Docker API in this way gourmet uses more nodes.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ DOCKER_HOST</span><span class="o">=</span><span class="s2">"tcp://192.168.13.1:2333"</span> ./gourmet api</code></pre></figure>


            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/swarm-scales-your-containter-for-free';
    this.page.identifier = 'https://gianarb.it/blog/swarm-scales-your-containter-for-free';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
