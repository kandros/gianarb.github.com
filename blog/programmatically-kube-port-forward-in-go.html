<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Programmatically Kubernetes port forward in Go</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Depending on your networking configuration port forwarding will may be the unique way for you to reach pods or services running in Kubernetes. When you develop a CLI integration that has to interact with pods running inside the cluster you can programmatically do a port forwarding in golang.">
    <meta name="keywords" content="kubernetes, k8s, golang, kubeassemble">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/programmatically-kube-port-forward-in-go">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="Programmatically Kubernetes port forward in Go">
    <meta name='twitter:description' content="Depending on your networking configuration port forwarding will may be the unique way for you to reach pods or services running in Kubernetes. When you develop a CLI integration that has to interact with pods running inside the cluster you can programmatically do a port forwarding in golang.">

    <meta property="og:title" content="Programmatically Kubernetes port forward in Go" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/programmatically-kube-port-forward-in-go" />
    <meta property="og:description" content="Depending on your networking configuration port forwarding will may be the unique way for you to reach pods or services running in Kubernetes. When you develop a CLI integration that has to interact with pods running inside the cluster you can programmatically do a port forwarding in golang." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:image" content="https://gianarb.it/img/gianarb.png" />
    <meta name='twitter:image' content="https://gianarb.it/img/gianarb.png">



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="Programmatically Kubernetes port forward in Go">
    <meta name="twitter:description" content="Depending on your networking configuration port forwarding will may be the unique way for you to reach pods or services running in Kubernetes. When you develop a CLI integration that has to interact with pods running inside the cluster you can programmatically do a port forwarding in golang.">
    <meta name="twitter:image:src" content="https://gianarb.it/img/gianarb.png">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>Programmatically Kubernetes port forward in Go</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">05 Dec 2019 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Seven minute read</span>
 · kubernetes, k8s, golang, kubeassemble</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <p>Along the way I saw at least two different ways to manage Kubernetes clusters
from a networking prospective. Some companies configure a VPN inside the
Kubernetes Cluster, in this way a developer connected in the VPN can reach pods
and services.</p>

<p>It is not mandatory but suggested having a good network segmentation in order
to be able to manage what a person connected in the VPN can touch and see.
Achieving this level of control is not easy in Kubernetes a lot of the open
source CNI plugin does not have this feature at all and I understand why in
operations this is evaluated as a safe approach. It is very convenient if close
an eye because pods and services are just IPs that you can reach from your
laptop and if you configure the VPN to push the Kubernetes DNS you can also
resolve them as DNS lookup.</p>

<p>The alternative I saw is to lock everybody out leaves as unique way to interact
with a service or a pod the command <code class="highlighter-rouge">kubectl port-forward</code>. In this way the
authentication and authorization method in Kubernetes allows you to decide who
can do port-forwarding on what based on namespace for example. Or at least you
can use Kubernetes Audit logs to figure out who did port forwarding if something
bad happens.</p>

<p>We tried both ways, I was to one pushing for the first, but we never achieved a
good segmentation and at some point I got locked down, sadly as it sound. Anyway
I like to automate things and I had to figure out a way to make my scripts to
work with this new approach.</p>

<p><img src="/img/sub.jpg" alt="" class="img-fluid" /></p>

<p>I started to dig in the <code class="highlighter-rouge">kubectl</code> code because we all know that it is capable of
doing the port forwarding. I had some trouble figuring out the right parameters
and to make them to work but at the end I did it! So here we are! If I can do it
you can do it as well!</p>

<p>The main repository with the code and an example is in
<a href="https://github.com/gianarb/kube-port-forward">github.com/gianarb/kube-port-forward</a>,
you can run it there. I am gonna explain it a bit here.</p>

<p>It is a simple CLI that mocks what <code class="highlighter-rouge">kubectl port-forward</code> already does but I
extrapolated the code needed to do and control a port forwarding. I will write
here as soon as the reason about why I did that is open source, I am telling it
to you right now STAY TUNED! It will be great!</p>

<p>First of all I used the <code class="highlighter-rouge">k8s.io/cli-runtime/pkg/genericclioptions</code> library to
configure a stream, we already used in the <a href="/blog/kubectl-flags-in-your-plugin">blog post about writing a CLI that
uses the same flags as the kubectl</a>. A
stream is a <code class="highlighter-rouge">struct</code> used by different <code class="highlighter-rouge">kubernetes</code> service when they need to
get or print information from a stream, in this case I am using <code class="highlighter-rouge">os.Stdout</code>,
<code class="highlighter-rouge">os.Stdin</code>, <code class="highlighter-rouge">os.Stderr</code> for simplicity, but where I do not need to print out the
output I use a <code class="highlighter-rouge">bytes.Stream</code> like this:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span><span class="x"> </span><span class="n">berr</span><span class="p">,</span><span class="x"> </span><span class="n">bout</span><span class="x"> </span><span class="n">bytes</span><span class="o">.</span><span class="n">Buffer</span><span class="x">
</span><span class="n">buffErr</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bufio</span><span class="o">.</span><span class="n">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">berr</span><span class="p">)</span><span class="x">
</span><span class="n">buffOut</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bufio</span><span class="o">.</span><span class="n">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bout</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>In order to make this code easy to read I had a structure to request the port
forwarding for a pod:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">PortForwardAPodRequest</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// RestConfig is the kubernetes config</span><span class="x">
	</span><span class="n">RestConfig</span><span class="x"> </span><span class="o">*</span><span class="n">rest</span><span class="o">.</span><span class="n">Config</span><span class="x">
	</span><span class="c">// Pod is the selected pod for this port forwarding</span><span class="x">
	</span><span class="n">Pod</span><span class="x"> </span><span class="n">v1</span><span class="o">.</span><span class="n">Pod</span><span class="x">
	</span><span class="c">// LocalPort is the local port that will be selected to expose the PodPort</span><span class="x">
	</span><span class="n">LocalPort</span><span class="x"> </span><span class="kt">int</span><span class="x">
	</span><span class="c">// PodPort is the target port for the pod</span><span class="x">
	</span><span class="n">PodPort</span><span class="x"> </span><span class="kt">int</span><span class="x">
	</span><span class="c">// Steams configures where to write or read input from</span><span class="x">
	</span><span class="n">Streams</span><span class="x"> </span><span class="n">genericclioptions</span><span class="o">.</span><span class="n">IOStreams</span><span class="x">
	</span><span class="c">// StopCh is the channel used to manage the port forward lifecycle</span><span class="x">
	</span><span class="n">StopCh</span><span class="x"> </span><span class="o">&lt;-</span><span class="k">chan</span><span class="x"> </span><span class="k">struct</span><span class="p">{}</span><span class="x">
	</span><span class="c">// ReadyCh communicates when the tunnel is ready to receive traffic</span><span class="x">
	</span><span class="n">ReadyCh</span><span class="x"> </span><span class="k">chan</span><span class="x"> </span><span class="k">struct</span><span class="p">{}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>And I wrote the function that actually does the port forward:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">PortForwardAPod</span><span class="p">(</span><span class="n">req</span><span class="x"> </span><span class="n">PortForwardAPodRequest</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">path</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"/api/v1/namespaces/%s/pods/%s/portforward"</span><span class="p">,</span><span class="x">
		</span><span class="n">req</span><span class="o">.</span><span class="n">Pod</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">Pod</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span><span class="x">
	</span><span class="n">hostIP</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">TrimLeft</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">RestConfig</span><span class="o">.</span><span class="n">Host</span><span class="p">,</span><span class="x"> </span><span class="s">"htps:/"</span><span class="p">)</span><span class="x">

	</span><span class="n">transport</span><span class="p">,</span><span class="x"> </span><span class="n">upgrader</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">spdy</span><span class="o">.</span><span class="n">RoundTripperFor</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">RestConfig</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">dialer</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">spdy</span><span class="o">.</span><span class="n">NewDialer</span><span class="p">(</span><span class="n">upgrader</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{</span><span class="n">Transport</span><span class="o">:</span><span class="x"> </span><span class="n">transport</span><span class="p">},</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">MethodPost</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">url</span><span class="o">.</span><span class="n">URL</span><span class="p">{</span><span class="n">Scheme</span><span class="o">:</span><span class="x"> </span><span class="s">"https"</span><span class="p">,</span><span class="x"> </span><span class="n">Path</span><span class="o">:</span><span class="x"> </span><span class="n">path</span><span class="p">,</span><span class="x"> </span><span class="n">Host</span><span class="o">:</span><span class="x"> </span><span class="n">hostIP</span><span class="p">})</span><span class="x">
	</span><span class="n">fw</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">portforward</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">dialer</span><span class="p">,</span><span class="x"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%d:%d"</span><span class="p">,</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">LocalPort</span><span class="p">,</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">PodPort</span><span class="p">)},</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">StopCh</span><span class="p">,</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">ReadyCh</span><span class="p">,</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">Streams</span><span class="o">.</span><span class="n">Out</span><span class="p">,</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">Streams</span><span class="o">.</span><span class="n">ErrOut</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">fw</span><span class="o">.</span><span class="n">ForwardPorts</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>
<p>An exercise that I can leave for you is to add Service support to this function,
you can open a PR if you like on
<a href="https://github.com/gianarb/kube-port-forward">github.com/gianarb/kube-port-forward</a>.</p>

<p>The <code class="highlighter-rouge">Stop</code> and <code class="highlighter-rouge">Ready</code> channels are crucial to manage the port forward because
as you see in the example it is a blocking operation it means that it will
luckily always run inside a goroutine. Those two channels gives you what you
need to understand when the port forward is ready to get traffic <code class="highlighter-rouge">ReadyCh</code> and
you have the capabilities to stop it <code class="highlighter-rouge">StopCh</code>.</p>

<p>My example is basic, I am closing the port forwarding when the <code class="highlighter-rouge">SIGTERM</code> signal
gets notified:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sigs</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Signal</span><span class="p">,</span><span class="x"> </span><span class="m">1</span><span class="p">)</span><span class="x">
</span><span class="n">signal</span><span class="o">.</span><span class="n">Notify</span><span class="p">(</span><span class="n">sigs</span><span class="p">,</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span><span class="x">
</span><span class="k">go</span><span class="x"> </span><span class="k">func</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="o">&lt;-</span><span class="n">sigs</span><span class="x">
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Bye..."</span><span class="p">)</span><span class="x">
    </span><span class="nb">close</span><span class="p">(</span><span class="n">stopCh</span><span class="p">)</span><span class="x">
    </span><span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span><span class="x">
</span><span class="p">}()</span><span class="x">
</span></code></pre></div></div>

<p>I just wait until the readyCh tells me that the connection is
up and running</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">readyCh</span><span class="o">:</span><span class="x">
    </span><span class="k">break</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="nb">println</span><span class="p">(</span><span class="s">"Port forwarding is ready to get traffic. have fun!"</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>As soon as I coded this feature I saw that it was gonna be an easy but useful
post. I wrote a <a href="/blog/extending-kubernetes-oreilly">report with O’Reilly</a> about
how to extend Kubernetes, you can find more about Go and Kube there. It is a
free PDF.</p>

<p>I hope you enjoyed it and <a href="https://twitter.com/gianarb">let me know</a> what cool
things you are gonna do port-forwarding the universe!</p>

            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/programmatically-kube-port-forward-in-go';
    this.page.identifier = 'https://gianarb.it/blog/programmatically-kube-port-forward-in-go';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
