<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>E2E testing Tinkerbell Setup tutorial in Go</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="My takeaway from having a to write a end to end test for the Tinkerbell Vagrant setup tutorial. How I wrote it and why, lesson learned and tips.">
    <meta name="keywords" content="vagrant, tinkerbell, golang, testing, framework">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/e2e-test-tinkerbell-vagrant-setup-with-go">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="E2E testing Tinkerbell Setup tutorial in Go">
    <meta name='twitter:description' content="My takeaway from having a to write a end to end test for the Tinkerbell Vagrant setup tutorial. How I wrote it and why, lesson learned and tips.">

    <meta property="og:title" content="E2E testing Tinkerbell Setup tutorial in Go" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/e2e-test-tinkerbell-vagrant-setup-with-go" />
    <meta property="og:description" content="My takeaway from having a to write a end to end test for the Tinkerbell Vagrant setup tutorial. How I wrote it and why, lesson learned and tips." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:image" content="https://gianarb.it/img/me.jpg" />
    <meta name='twitter:image' content="https://gianarb.it/img/me.jpg">



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="E2E testing Tinkerbell Setup tutorial in Go">
    <meta name="twitter:description" content="My takeaway from having a to write a end to end test for the Tinkerbell Vagrant setup tutorial. How I wrote it and why, lesson learned and tips.">
    <meta name="twitter:image:src" content="https://gianarb.it/img/me.jpg">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>E2E testing Tinkerbell Setup tutorial in Go</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">03 Aug 2020 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">13 minute read</span>
 · vagrant, tinkerbell, golang, testing, framework</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <p><a href="https://tinkerbell.org">Tinkerbell</a> is a tool open sourced recently by
<a href="https://packet.com">Packet, an Equinix company</a>, the company I work for.</p>

<p>It is a provisioner for bare metal. You can switch servers on and off via API,
executing workflows and install operating systems on a server that does not have
one!</p>

<p>Tinkerbell is in its early days as open source project but the concept is battle
tested from 6 years of production use internally at Packet.</p>

<p>I am excited to learn a lot of the cool technologies that are making datacenters
working, but I am not here to write about it<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>.</p>

<p>One of my recent tasks<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> was about end to end testing the Vagrant Setup
tutorial<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup> we wrote.</p>

<p>I like the idea! The Setup tutorial is important for our community because it is
the entry point for a lot of people and having a consistent way to test its
accuracy is crucial.</p>

<p>It is also a quick way to get a valuable end to end test running that covers the
entire project, at a high level.</p>

<p>Tinkerbell is under development and it is easy to make mistakes and break
things at this point, we have to know when it happens. Tinkerbell requires
virtualisation capabilities, and we do not have an end to end testing framework
for that yet.</p>

<h2 id="tell-me-more-about-the-test-itself">Tell me more about the test itself</h2>

<p>It is a long tasks but let’s summarize it (have a look at the tutorial, it helps
to read this article moving forward):</p>

<ol>
  <li>The script has to start a vagrant machine called provisioner</li>
  <li>When the provisioner is up it has to exec via ssh a docker-compose command
that starts a bunch of containers, one of those is Tink grpc server</li>
  <li>When Tinkerbell is up and running we have to do a bunch of things like:
 a. Register a new hardware
 b. Create a template
 c. Create the workflow that will get executed in the worker from a template</li>
  <li>Start the worker</li>
  <li>Wait and check if the workflows executes as expected.</li>
</ol>

<p>NOTE: the test should  clean up after itself, Vagrant is not ideal
to get parallelization of VMs, and we do not support it. A dirty environment
will break future tests as it is today.</p>

<h2 id="how-to-write-this-test">How to write this test</h2>

<p>There are a million way to write end to end test the one I evaluated are bash
and Go.</p>

<p>The project is in Go, Tinkerbell serves a gRPC server and a client, I thought it
was a good idea to write everything in Go to try the client itself and because
it is easier to coordinate long running actions with channels and context
compared with bash for example. Or at least that’s what I think.</p>

<p>I can also keep the code inside the <code class="highlighter-rouge">testing</code> framework that Go provides keeping
the test closer to the code and the developers that contribute to the project,
compared with a random <code class="highlighter-rouge">scripts.sh</code>.</p>

<p>I am not sure if this will be useful in the future but one of my goal was to
serve a clean API and a small framework that can be used to write other tests
that starts from the Vagrant setup. This is the API I designed:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">Vagrant</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">Up</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">opts</span><span class="x"> </span><span class="o">...</span><span class="n">VagrantOpt</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">Vagrant</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">v</span><span class="x"> </span><span class="o">*</span><span class="n">Vagrant</span><span class="p">)</span><span class="x"> </span><span class="n">Destroy</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">v</span><span class="x"> </span><span class="o">*</span><span class="n">Vagrant</span><span class="p">)</span><span class="x"> </span><span class="n">Exec</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="x"> </span><span class="o">...</span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{}</span><span class="x">
</span></code></pre></div></div>

<p>Consistency is important, developers who knows vagrant or that will have to fix
the tests coming from the tutorial will know <code class="highlighter-rouge">Up</code>, <code class="highlighter-rouge">Destroy</code> and <code class="highlighter-rouge">Exec</code> because
those verbs are used by Vagrant and in the documentation itself.</p>

<p>Even for Go developers <code class="highlighter-rouge">Exec</code> is not a new function, <code class="highlighter-rouge">os/exec</code><sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup> exists and it
does a similar job, the one I wrote is over ssh.</p>

<p>This library now has its own repository:
<a href="https://github.com/gianarb/vagrant-go">gianarb/vagrant-go</a>.</p>

<h2 id="go-challenges-and-tips-and-tricks">Go challenges and tips and tricks</h2>

<p>I would like to share some of the challenges I faced when writing the Vagrant
framework and some tips useful for this task.</p>

<h2 id="opt-are-great">Opt are great!</h2>

<p>I have to say options are great! It is a well known pattern in Go and it
translates to:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ctx</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">()</span><span class="x">

</span><span class="n">machine</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">vagrant</span><span class="o">.</span><span class="n">Up</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x">
    </span><span class="n">vagrant</span><span class="o">.</span><span class="n">WithLogger</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Logf</span><span class="p">),</span><span class="x">
    </span><span class="n">vagrant</span><span class="o">.</span><span class="n">WithMachineName</span><span class="p">(</span><span class="s">"provisioner"</span><span class="p">),</span><span class="x">
    </span><span class="n">vagrant</span><span class="o">.</span><span class="n">WithWorkdir</span><span class="p">(</span><span class="s">"../../deploy/vagrant"</span><span class="p">),</span><span class="x">
</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>It allowed me to add new options and to tune the Vagrant struct with strong
default. If you never used it, do it! It is pretty easy, you need an interface
like this:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">VagrantOpt</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="o">*</span><span class="n">Vagrant</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>In this way you can write as many <code class="highlighter-rouge">With</code>function you need:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">WithStderr</span><span class="p">(</span><span class="n">s</span><span class="x"> </span><span class="n">io</span><span class="o">.</span><span class="n">ReadWriter</span><span class="p">)</span><span class="x"> </span><span class="n">VagrantOpt</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="n">v</span><span class="x"> </span><span class="o">*</span><span class="n">Vagrant</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">v</span><span class="o">.</span><span class="n">Stderr</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">s</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">RunAsync</span><span class="p">()</span><span class="x"> </span><span class="n">VagrantOpt</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="n">v</span><span class="x"> </span><span class="o">*</span><span class="n">Vagrant</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">v</span><span class="o">.</span><span class="n">async</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">true</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>I execute the opts as part of the <code class="highlighter-rouge">Up</code> function:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">Up</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">opts</span><span class="x"> </span><span class="o">...</span><span class="n">VagrantOpt</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">Vagrant</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">const</span><span class="x"> </span><span class="p">(</span><span class="x">
		</span><span class="n">defaultVagrantBin</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"vagrant"</span><span class="x">
		</span><span class="n">defaultName</span><span class="x">       </span><span class="o">=</span><span class="x"> </span><span class="s">"vagrant"</span><span class="x">
		</span><span class="n">defaultWorkdir</span><span class="x">    </span><span class="o">=</span><span class="x"> </span><span class="s">"."</span><span class="x">
	</span><span class="p">)</span><span class="x">
	</span><span class="n">v</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Vagrant</span><span class="p">{</span><span class="x">
		</span><span class="n">VagrantBinPath</span><span class="o">:</span><span class="x"> </span><span class="n">defaultVagrantBin</span><span class="p">,</span><span class="x">
		</span><span class="n">Name</span><span class="o">:</span><span class="x">           </span><span class="n">defaultName</span><span class="p">,</span><span class="x">
		</span><span class="n">Workdir</span><span class="o">:</span><span class="x">        </span><span class="n">defaultWorkdir</span><span class="p">,</span><span class="x">
		</span><span class="n">log</span><span class="o">:</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="n">format</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="x"> </span><span class="o">...</span><span class="k">interface</span><span class="p">{})</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="p">))</span><span class="x">
		</span><span class="p">},</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">opt</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">opts</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">opt</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

    </span><span class="c">// ...</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h3 id="test-segmentation-with-packages">test segmentation with packages</h3>

<p>I don’t want to run the vagrant end to end tests as part of the default test
suite because they take too much time and they require Vagrant installed. They
do not even run in CI in the same way unit test works, but I will get to it
later.</p>

<p>I learned that packages that starts with <code class="highlighter-rouge">_</code> does not get executed when using
something like <code class="highlighter-rouge">./...</code>.</p>

<p>I wrote the framework and tests as part of the package:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">./test/_vagrant/
    ./vagrant.go
    ./vagrant_test.go
</span></code></pre></div></div>

<p>In this way to run the tests you have to explicitly call the package out:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> go <span class="nb">test</span> ./test/_vagrant
</code></pre></div></div>

<h3 id="observability-or-what-is-going-on">Observability or “what is going on?”</h3>

<p>Go has its own way to print logs during the execution of the tests:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> go <span class="nb">test</span> <span class="nt">-v</span> ./...
</code></pre></div></div>

<p>It works because <code class="highlighter-rouge">testing</code> has a function called <code class="highlighter-rouge">t.Log</code> and <code class="highlighter-rouge">t.Logf</code>. Those
functions watches the <code class="highlighter-rouge">-v</code> flags. To be complaint with that and to keep the
<code class="highlighter-rouge">Vagrant</code> struct agnostic I wrote a <code class="highlighter-rouge">WithLogger</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">WithLogger</span><span class="p">(</span><span class="n">log</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="o">...</span><span class="k">interface</span><span class="p">{}))</span><span class="x"> </span><span class="n">VagrantOpt</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="n">v</span><span class="x"> </span><span class="o">*</span><span class="n">Vagrant</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">v</span><span class="o">.</span><span class="n">log</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">log</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>The function it accepts as a argument is <code class="highlighter-rouge">t.Logf</code>.</p>

<p>Continuous Integrations runs with verbosity enabled for this task because it is
long and complicated, the logging prints all the outputs from the <code class="highlighter-rouge">vagrant up</code>
and <code class="highlighter-rouge">destroy</code> command, and the stdout for the <code class="highlighter-rouge">exec</code> over ssh, it gives a very
good overview about what is going on.</p>

<h3 id="stdout-and-stdin-buffer-and-loggers">Stdout and Stdin, buffer and loggers</h3>

<p>I don’t have a lot to say about this other than: “it was very hard to do!!”.
The code that fixed my problems can be summarized in this way:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stderrPipe</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">cmd</span><span class="o">.</span><span class="n">StderrPipe</span><span class="p">()</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"exec error: %v"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="n">stdoutPipe</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">cmd</span><span class="o">.</span><span class="n">StdoutPipe</span><span class="p">()</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"exec error: %v"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">go</span><span class="x"> </span><span class="n">v</span><span class="o">.</span><span class="n">pipeOutput</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s stderr"</span><span class="p">,</span><span class="x"> </span><span class="n">cmd</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span><span class="x"> </span><span class="n">bufio</span><span class="o">.</span><span class="n">NewScanner</span><span class="p">(</span><span class="n">stderrPipe</span><span class="p">))</span><span class="x">
</span><span class="k">go</span><span class="x"> </span><span class="n">v</span><span class="o">.</span><span class="n">pipeOutput</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s stdout"</span><span class="p">,</span><span class="x"> </span><span class="n">cmd</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span><span class="x"> </span><span class="n">bufio</span><span class="o">.</span><span class="n">NewScanner</span><span class="p">(</span><span class="n">stdoutPipe</span><span class="p">))</span><span class="x">

</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">cmd</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span><span class="x">
</span></code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">v</span><span class="x"> </span><span class="o">*</span><span class="n">Vagrant</span><span class="p">)</span><span class="x"> </span><span class="n">pipeOutput</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">name</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">scanner</span><span class="x"> </span><span class="o">*</span><span class="n">bufio</span><span class="o">.</span><span class="n">Scanner</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">scanner</span><span class="o">.</span><span class="n">Scan</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">ctx</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span><span class="o">:</span><span class="x">
			</span><span class="k">return</span><span class="x">
		</span><span class="k">default</span><span class="o">:</span><span class="x">
			</span><span class="n">v</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">"[pipeOutput %s] %s"</span><span class="p">,</span><span class="x"> </span><span class="n">name</span><span class="p">,</span><span class="x"> </span><span class="n">scanner</span><span class="o">.</span><span class="n">Text</span><span class="p">())</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h3 id="kill-process-and-subprocess">Kill process and subprocess</h3>

<p>There are a lot of process going on when creating or destroying a VM with
Vagrant. There is VirtualBox for example, and we have an edge case for the
worker machine because the <code class="highlighter-rouge">up</code> commands technically never ends, it is in
pending until you <code class="highlighter-rouge">destroy</code> the machine. But you can’t run multiple commands
against the same machine because <code class="highlighter-rouge">up</code> holds a lock and it blocks <code class="highlighter-rouge">destroy</code> to
execute. <code class="highlighter-rouge">os/exec</code> helps here but you have to tune it a little bit:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cmd</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">exec</span><span class="o">.</span><span class="n">CommandContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">v</span><span class="o">.</span><span class="n">VagrantBinPath</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">...</span><span class="p">)</span><span class="x">
</span><span class="n">cmd</span><span class="o">.</span><span class="n">Dir</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">v</span><span class="o">.</span><span class="n">Workdir</span><span class="x">
</span><span class="n">cmd</span><span class="o">.</span><span class="n">Stdout</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">v</span><span class="o">.</span><span class="n">Stdout</span><span class="x">
</span><span class="n">cmd</span><span class="o">.</span><span class="n">Stderr</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">v</span><span class="o">.</span><span class="n">Stderr</span><span class="x">
</span><span class="n">cmd</span><span class="o">.</span><span class="n">SysProcAttr</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">syscall</span><span class="o">.</span><span class="n">SysProcAttr</span><span class="p">{</span><span class="n">Setpgid</span><span class="o">:</span><span class="x"> </span><span class="no">true</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>Now when killing <code class="highlighter-rouge">cmd</code> the subprocess terminates as well.</p>

<h2 id="continuous-integration">Continuous Integration</h2>

<p>We decided to go with GitHub Actions with a self running runner, in this way we
can use Packet bare metal that supports virtualisation.</p>

<p>As I told you I don’t want this test to run for all the commit, or for all the
pull request because it is time and resource consuming. It is also risky, so I
want maintainers to decide when to trigger it.</p>

<p>That’s why it gets triggered with a GitHub label:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Setup with Vagrant on Packet</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">types</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">labeled</span><span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">vagrant-setup</span><span class="pi">:</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">contains(github.event.pull_request.labels.*.name, 'ci-check/vagrant-setup')</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">self-hosted</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Vagrant Test</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="no">export VAGRANT_DEFAULT_PROVIDER="virtualbox"</span>
        <span class="no">go test -v ./test/_vagrant</span>
</code></pre></div></div>

<p>This is what it takes to make the process working!! And I am still surprised it
is so easy! When a contributor label a PR with <code class="highlighter-rouge">ci-check/vagrant-setup</code> the
process starts. My idea was to remove the label straight away, but I am
<a href="https://github.community/t/actions-ecosystem-action-remove-labels-fails-resource-not-accessible-by-integration/124188">blocked</a>.</p>

<p>An alternative that we are evaluating is to run it as a cronjob<sup id="fnref:5"><a href="#fn:5" class="footnote">5</a></sup> as well.</p>

<h2 id="testing-is-the-real-power">Testing is the real power</h2>

<p>E2E testing are fun to write because they bring a lot of challenges in terms of
coordination and stability. You have to write good code in order to make them
stable. I hope you learned something from my experience and if you have any
question let me know <a href="https://twitter.com/gianarb">here</a>. I am happy to go
deeper on some of those topics based on your suggestions.</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>If you are curious ask me any question on Twitter @gianarb <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>https://github.com/tinkerbell/sandbox/pull/7 <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>https://tinkerbell.org/setup/local-with-vagrant/ <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>https://golang.org/pkg/os/exec/#pkg-examples <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:5">
      <p>https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#onschedule <a href="#fnref:5" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/e2e-test-tinkerbell-vagrant-setup-with-go';
    this.page.identifier = 'https://gianarb.it/blog/e2e-test-tinkerbell-vagrant-setup-with-go';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
