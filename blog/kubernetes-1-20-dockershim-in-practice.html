<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Kubenetes v1.20 the docker deprecation dilemma in practice</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="there are many discussions going on Twitter about why Kubernetes v1.20 deprecated Docker and dockershim as default runtime. But it was a well thought an planned effort. Nothing to really worry about and here I will go over the process of updating Kubenetes from 1.19 to 1.20">
    <meta name="keywords" content="golang">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/kubernetes-1-20-dockershim-in-practice">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="Kubenetes v1.20 the docker deprecation dilemma in practice">
    <meta name='twitter:description' content="there are many discussions going on Twitter about why Kubernetes v1.20 deprecated Docker and dockershim as default runtime. But it was a well thought an planned effort. Nothing to really worry about and here I will go over the process of updating Kubenetes from 1.19 to 1.20">

    <meta property="og:title" content="Kubenetes v1.20 the docker deprecation dilemma in practice" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/kubernetes-1-20-dockershim-in-practice" />
    <meta property="og:description" content="there are many discussions going on Twitter about why Kubernetes v1.20 deprecated Docker and dockershim as default runtime. But it was a well thought an planned effort. Nothing to really worry about and here I will go over the process of updating Kubenetes from 1.19 to 1.20" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="Kubenetes v1.20 the docker deprecation dilemma in practice">
    <meta name="twitter:description" content="there are many discussions going on Twitter about why Kubernetes v1.20 deprecated Docker and dockershim as default runtime. But it was a well thought an planned effort. Nothing to really worry about and here I will go over the process of updating Kubenetes from 1.19 to 1.20">
    <meta name="twitter:image:src" content="https://gianarb.it">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>Kubenetes v1.20 the docker deprecation dilemma in practice</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">03 Dec 2020 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Seven minute read</span>
 · golang</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <p>Kubernetes v1.20 is not yet out but there is already a lot going on behind the
scene. The main reason is the deprecation of Docker as default runtime.</p>

<p>I won’t go too deep in the theory because at this point I think it is a well
covered part. But a few things:</p>

<ol>
  <li>If you run Docker, you run containerd. That’s it. Even if you didn’t know, or
you don’t like the idea.</li>
  <li>The container runtime interface is there since a good amount of time and the
goal for it was to decouple the orchestrator (kubernetes), from other
business like running containers. Who cares about containers at the end.</li>
  <li>Deprecating dockershim or at least removing it from the kubelet itself is the
right thing to do.</li>
</ol>

<p>More about this topic:</p>

<ul>
  <li><a href="https://kubernetes.io/blog/2020/12/02/dockershim-faq/">Dockershim Deprecation FAQ</a></li>
  <li><a href="https://kubernetes.io/blog/2020/12/02/dont-panic-kubernetes-and-docker/">Don’t Panic: Kubernetes and Docker</a></li>
</ul>

<p>I want to tell you how it works in practice. And this article contains my
experience updating a Kubernetes cluster from v1.19 to v1.20.</p>

<p>So I created a two node clusters on <a href="https://console.equinix.com/">Equinix
Metal</a> running Ubuntu using this simple script and
kubeadm.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!bin/bash</span>

apt-get update
apt-get install <span class="nt">-y</span> vim git

apt-get install <span class="nt">-y</span> <span class="se">\</span>
    apt-transport-https <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    curl <span class="se">\</span>
    gnupg-agent <span class="se">\</span>
    vim <span class="se">\</span>
    git <span class="se">\</span>
    software-properties-common

<span class="nv">releaseName</span><span class="o">=</span><span class="k">$(</span>lsb_release <span class="nt">-cs</span><span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$releaseName</span> <span class="o">==</span> <span class="s2">"groovy"</span> <span class="o">]</span>
<span class="k">then
    </span><span class="nv">releaseName</span><span class="o">=</span><span class="s2">"focal"</span>
<span class="k">fi

</span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add -
apt-key fingerprint 0EBFCD88
add-apt-repository <span class="se">\</span>
   <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class="se">\</span><span class="s2">
   </span><span class="k">${</span><span class="nv">releaseName</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
   test"</span>

apt-get update
apt-get install <span class="nt">-y</span> docker-ce docker-ce-cli containerd.io

apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get install <span class="nt">-y</span> apt-transport-https curl
curl <span class="nt">-s</span> https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
</span><span class="no">EOF
</span><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get install <span class="nt">-y</span> kubelet kubeadm kubectl
<span class="nb">sudo </span>apt-mark hold kubelet kubeadm kubectl
</code></pre></div></div>

<p>I placed that script as CloudInit for my two nodes and I ran <code class="highlighter-rouge">kubeadm init/join</code>
to get my cluster.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span> kubectl get node
<span class="go">NAME            STATUS   ROLES    AGE     VERSION
gianarb-k8s     Ready    master   2m11s   v1.19.4
</span><span class="gp">gianarb-k8s01   Ready    &lt;none&gt;</span>   91s     v1.19.4
</code></pre></div></div>

<p>I have installed Flannel and now the nodes are ready. That’s it. That’s how I
measure success here.</p>

<p>It is not time to update to v1.20, so I downloaded the binaries from the
registry.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span> wget https://dl.k8s.io/v1.20.0-rc.0/kubernetes-server-linux-amd64.tar.gz
<span class="gp">#</span> <span class="nb">tar </span>xzvf ./kubernetes-server-linux-amd64.tar.gz
<span class="gp">#</span> ./kubernetes/server/bin/kubeadm version
<span class="go">kubeadm version: &amp;version.Info{Major:"1", Minor:"20+", GitVersion:"v1.20.0-rc.0", GitCommit:"3321f00ed14e07f774b84d3198ede545c1dee697", GitTreeState:"clean", BuildDate:"2020-12-01T10:36:46Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"}
</span></code></pre></div></div>

<p>I checked available upgrade plan from <code class="highlighter-rouge">kubeadm</code> with the flag
<code class="highlighter-rouge">--allow-experimental-upgrades</code>, if you do this process when v1.20 will be
officially released, you won’t need that flag.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">./kubernetes/server/bin/kubeadm upgrade plan --allow-experimental-upgrades
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[preflight] Running pre-flight checks.
[upgrade] Running cluster health checks
[upgrade] Fetching available versions to upgrade to
[upgrade/versions] Cluster version: v1.19.4
[upgrade/versions] kubeadm version: v1.20.0-rc.0
[upgrade/versions] Latest stable version: v1.19.4
[upgrade/versions] Latest stable version: v1.19.4
[upgrade/versions] Latest version in the v1.19 series: v1.19.4
[upgrade/versions] Latest version in the v1.19 series: v1.19.4
</span><span class="gp">I1203 21:50:13.860850   59152 version.go:251] remote version is much newer: v1.21.0-alpha.0;</span> falling back to: stable-1.20
<span class="go">W1203 21:50:14.100325   59152 version.go:101] could not fetch a Kubernetes version from the internet: unable to fetch file. URL: "https://dl.k8s.io/release/stable-1.20.txt", status: 404 Not Found
W1203 21:50:14.100362   59152 version.go:102] falling back to the local client version: v1.20.0-rc.0
[upgrade/versions] Latest experimental version: v1.20.0-rc.0
[upgrade/versions] Latest experimental version: v1.20.0-rc.0
[upgrade/versions] Latest : v1.19.5-rc.0
[upgrade/versions] Latest : v1.19.5-rc.0

Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT       AVAILABLE
kubelet     2 x v1.19.4   v1.20.0-rc.0

Upgrade to the latest experimental version:

COMPONENT                 CURRENT    AVAILABLE
kube-apiserver            v1.19.4    v1.20.0-rc.0
kube-controller-manager   v1.19.4    v1.20.0-rc.0
kube-scheduler            v1.19.4    v1.20.0-rc.0
kube-proxy                v1.19.4    v1.20.0-rc.0
CoreDNS                   1.7.0      1.7.0
etcd                      3.4.13-0   3.4.13-0

You can now apply the upgrade by executing the following command:

        kubeadm upgrade apply v1.20.0-rc.0 --allow-release-candidate-upgrades

_____________________________________________________________________


The table below shows the current state of component configs as understood by this version of kubeadm.
Configs that have a "yes" mark in the "MANUAL UPGRADE REQUIRED" column require manual config upgrade or
resetting to kubeadm defaults before a successful upgrade can be performed. The version to manually
upgrade to is denoted in the "PREFERRED VERSION" column.

API GROUP                 CURRENT VERSION   PREFERRED VERSION   MANUAL UPGRADE REQUIRED
kubeproxy.config.k8s.io   v1alpha1          v1alpha1            no
kubelet.config.k8s.io     v1beta1           v1beta1             no
_____________________________________________________________________
</span></code></pre></div></div>

<p>As you can see from the output there is <code class="highlighter-rouge">v1.20.0-rc.0</code> available so it is time
to apply that plan and rollout the upgrade.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span> ./kubernetes/server/bin/kubeadm upgrade apply v1.20.0-rc.0 <span class="nt">--allow-release-candidate-upgrades</span>
<span class="go">[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[preflight] Running pre-flight checks.
[upgrade] Running cluster health checks
[upgrade/version] You have chosen to change the cluster version to "v1.20.0-rc.0"
[upgrade/versions] Cluster version: v1.19.4
[upgrade/versions] kubeadm version: v1.20.0-rc.0
[upgrade/confirm] Are you sure you want to proceed with the upgrade? [y/N]: y
</span><span class="c">...
</span></code></pre></div></div>

<p>Time to check kubelet with journalctl</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span>journalctl <span class="nt">-xe</span> <span class="nt">-u</span> kubeletDec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.648539  108749 server.go:416] Version: v1.20.0-rc.0
<span class="go">
Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.649168  108749 server.go:837] Client rotation is on, will bootstrap in background
Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.651975  108749 certificate_store.go:130] Loading cert/key pair from "/var/lib/kubelet/pki/kubelet-client-current.pem".
Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.653428  108749 dynamic_cafile_content.go:167] Starting client-ca-bundle::/etc/kubernetes/pki/ca.crt
Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.764200  108749 server.go:645] --cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to /
Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.764717  108749 container_manager_linux.go:274] container manager verified user specified cgroup-root exists: []
</span><span class="gp">Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.764743  108749 container_manager_linux.go:279] Creating Container Manager object based on Node Config: {RuntimeCgroupsName: SystemCgroupsName: KubeletCgroupsName: ContainerRuntime&gt;</span>
<span class="go">Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.764862  108749 topology_manager.go:120] [topologymanager] Creating topology manager with none policy per container scope
Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.764874  108749 container_manager_linux.go:310] [topologymanager] Initializing Topology Manager with none policy and container-level scope
Dec 03 21:58:49 gianarb-k8s kubelet[108749]: I1203 21:58:49.764881  108749 container_manager_linux.go:315] Creating device plugin manager: true
Dec 03 21:58:49 gianarb-k8s kubelet[108749]: W1203 21:58:49.765010  108749 kubelet.go:297] Using dockershim is deprecated, please consider using a full-fledged CRI implementation
</span></code></pre></div></div>

<p>We finally got it <code class="highlighter-rouge">Using dockershim is deprecated, please consider using a
full-fledged CRI implementation</code>. But everything still works.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span> kubectl get node
<span class="go">NAME            STATUS   ROLES                  AGE   VERSION
gianarb-k8s     Ready    control-plane,master   17m   v1.20.0-rc.0
</span><span class="gp">gianarb-k8s01   Ready    &lt;none&gt;</span>                 16m   v1.19.4
</code></pre></div></div>

<p>There is something cool as well, now the role is <code class="highlighter-rouge">control-plane</code> and <code class="highlighter-rouge">master</code>, I
am sure at some point we will deprecate <code class="highlighter-rouge">master</code> as well and this is just a
transition phase, same as it happened for Docker Shim.</p>

<p>We don’t want that working, so it is not time to change the default
configuration of <code class="highlighter-rouge">containerd</code>, because as you know, it is there sitting behind
docker since forever almost.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">cat /etc/containerd/

</span><span class="gp">#</span> <span class="nb">cat</span> /etc/containerd/config.toml
<span class="c">... 
</span><span class="gp">#</span> comment this line because we need cri <span class="nb">enable</span>
<span class="gp">#</span> disabled_plugins <span class="o">=</span> <span class="o">[</span><span class="s2">"cri"</span><span class="o">]</span>
<span class="c">...
</span></code></pre></div></div>

<p>We need to enable the plugin <code class="highlighter-rouge">cri</code>, by default it is disabled when installing
docker-ce via the Docker registry because <code class="highlighter-rouge">dockerd</code> does not need a CRI, but
Kubernetes needs it obviously. Now you can restart the service with <code class="highlighter-rouge">systemctl</code>
and we have to tell the kubelet that now it has to use <code class="highlighter-rouge">containerd</code>.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span> mkdir <span class="nt">-p</span> /etc/systemd/system/kubelet.service.d/
<span class="go">cat &lt;&lt; EOF | sudo tee  /etc/systemd/system/kubelet.service.d/0-containerd.conf
[Service]
Environment="KUBELET_EXTRA_ARGS=--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock"
EOF
</span></code></pre></div></div>

<p>After a systemd daemon reload and a kubelet.service restart we are back again.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># kubectl get node
NAME            STATUS   ROLES                  AGE   VERSION
gianarb-k8s     Ready    control-plane,master   23m   v1.20.0-rc.0
gianarb-k8s01   Ready    &lt;none&gt;                 23m   v1.19.4
</code></pre></div></div>

<p>Exercise for you, have a look at the kubelet logs, the warning is not there
anymore and you are good to go.</p>

            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/kubernetes-1-20-dockershim-in-practice';
    this.page.identifier = 'https://gianarb.it/blog/kubernetes-1-20-dockershim-in-practice';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
