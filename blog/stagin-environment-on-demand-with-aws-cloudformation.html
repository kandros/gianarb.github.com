<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Staging environment on demand with AWS Cloudformation</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Environment are ephemeral. They come and go really quickly based on needs. AWS delivers a service called CloudFormation that allows you to easy describe via JSON or YALM specification a lot of AWS resources like EC2, Route53 hosted zone and domains, RDS, VPC, subnet and almost everything you normally do via console. This is infrastructure as code applied to AWS resource allows you to version and push on git entire AWS environment. You can replicate it over and over.">
    <meta name="keywords" content="devops, aws, automation, cloudformation, json, cloud, amazon web service, cf, infrastructure as code, infra as code">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/stagin-environment-on-demand-with-aws-cloudformation">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="Staging environment on demand with AWS Cloudformation">
    <meta name='twitter:description' content="Environment are ephemeral. They come and go really quickly based on needs. AWS delivers a service called CloudFormation that allows you to easy describe via JSON or YALM specification a lot of AWS resources like EC2, Route53 hosted zone and domains, RDS, VPC, subnet and almost everything you normally do via console. This is infrastructure as code applied to AWS resource allows you to version and push on git entire AWS environment. You can replicate it over and over.">

    <meta property="og:title" content="Staging environment on demand with AWS Cloudformation" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/stagin-environment-on-demand-with-aws-cloudformation" />
    <meta property="og:description" content="Environment are ephemeral. They come and go really quickly based on needs. AWS delivers a service called CloudFormation that allows you to easy describe via JSON or YALM specification a lot of AWS resources like EC2, Route53 hosted zone and domains, RDS, VPC, subnet and almost everything you normally do via console. This is infrastructure as code applied to AWS resource allows you to version and push on git entire AWS environment. You can replicate it over and over." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:image" content="https://gianarb.it/img/amazon-aws-logo.jpg" />
    <meta name='twitter:image' content="https://gianarb.it/img/amazon-aws-logo.jpg">



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="Staging environment on demand with AWS Cloudformation">
    <meta name="twitter:description" content="Environment are ephemeral. They come and go really quickly based on needs. AWS delivers a service called CloudFormation that allows you to easy describe via JSON or YALM specification a lot of AWS resources like EC2, Route53 hosted zone and domains, RDS, VPC, subnet and almost everything you normally do via console. This is infrastructure as code applied to AWS resource allows you to version and push on git entire AWS environment. You can replicate it over and over.">
    <meta name="twitter:image:src" content="https://gianarb.it/img/amazon-aws-logo.jpg">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>Staging environment on demand with AWS Cloudformation</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">08 Jul 2015 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">20 minute read</span>
 · devops, aws, automation, cloudformation, json, cloud, amazon web service, cf, infrastructure as code, infra as code</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <blockquote class="twitter-tweet tw-align-center" lang="en"><p lang="en" dir="ltr">Staging environment on demand. To Work on <a href="https://twitter.com/hashtag/AWS?src=hash">#AWS</a> low level with <a href="https://twitter.com/hashtag/cloudformation?src=hash">#cloudformation</a> <a href="https://t.co/VWBR129637">https://t.co/VWBR129637</a> <a href="https://twitter.com/hashtag/cloud?src=hash">#cloud</a> <a href="https://twitter.com/hashtag/devops?src=hash">#devops</a></p>&mdash; Gianluca Arbezzano (@GianArb) <a href="https://twitter.com/GianArb/status/621691855810494464">July 16, 2015</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="staging-environment">Staging Environment</h2>
<p>There are few environments during my developer workflow, today I chose a little example:</p>

<ul>
  <li>Production enviroment always exists, it runs the stable application and you can not use it for your test.</li>
  <li><strong>Staging</strong> enviroment is a “pre-production” state.</li>
  <li>Develop enviroment is instable and it runs new features and fixes, here there’s the work of all team but it’s not ready to go in production.</li>
</ul>

<p><img src="/img/cloudformation-staging/staging.jpg" alt="Staging graph" /></p>

<p>Staging environment in my opinion could be “volatile” version, we use it when our product is ready to go in production for the last time it was unused. Maybe this statement isn’t real in your work but if you think a little team of consultants that
 work on different projects maybe this words have a sense.</p>

<h2 id="aws-cloudformation">AWS Cloudformation</h2>
<p>CloudFormation is an AWS service that helps you to orchestate all AWS services, you can write a template in JSON and you can use it to create an infrastructure with one click.
This solution helps me  to build and destroy this environment and we can pay it only if it’s necessary, if you use a <code class="highlighter-rouge">stagin env == production env</code> it can be very very expensive.
This solution could help you to down cost.</p>

<h2 id="current-infrastructure">Current infrastructure</h2>

<p><img src="/img/cloudformation-staging/infra.jpg" alt="RDS and EC2 infrastructure" /></p>

<p>This is my template to build a simple application Frontend + MySQL (RDS).
In this implementation I build network configuration and I create one instance of RDS and one EC2 (my frontend).
<code class="highlighter-rouge">Parameters</code> key is the list of external parameters that I can use to configure my template, for example database and EC2 key pair, my root’s password..
<code class="highlighter-rouge">Resources</code> key contains description of all actors of this infrastructure.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"Parameters"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"VPCName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"staging"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"VPC name"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"ProjectName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"app"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Project name"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"WebKey"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"web-key"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Ssh key to log into the web instances"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"WebInstanceType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"m3.medium"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Web instance type"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"WebInstanceImage"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ami-47a23a30"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Web instance image"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseInstanceType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"db.m3.medium"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Database instance type"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"mydb"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Database instance's name"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseMasterUsername"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"gianarb"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of master user"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseEngineVersion"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"5.6"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MySQL version"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseUserPassword"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"test1234"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"User password"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabasePublicAccess"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseMultiAZ"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"Resources"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"Staging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::VPC"</span><span class="p">,</span><span class="w">
       </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"CidrBlock"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"10.15.0.0/16"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"EnableDnsSupport"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="s2">"EnableDnsHostnames"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="s2">"InstanceTenancy"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"default"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"Tags"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VPCName"</span><span class="p">}}]</span><span class="w">
       </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseSubnet1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::Subnet"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"AvailabilityZone"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"eu-west-1a"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"CidrBlock"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"10.15.1.0/28"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"MapPublicIpOnLaunch"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"VpcId"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"Tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"db-1a"</span><span class="p">}]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseSubnet2"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::Subnet"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"AvailabilityZone"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"eu-west-1b"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"CidrBlock"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"10.15.1.16/28"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"MapPublicIpOnLaunch"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"VpcId"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"Tags"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"db-1b"</span><span class="p">}]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"WebSubnet1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::Subnet"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"AvailabilityZone"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"eu-west-1a"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"CidrBlock"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"10.15.0.8/28"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"MapPublicIpOnLaunch"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"VpcId"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"Tags"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web-1a"</span><span class="p">}]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"RDSSubnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::RDS::DBSubnetGroup"</span><span class="p">,</span><span class="w">
     </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"DBSubnetGroupDescription"</span><span class="p">:</span><span class="w"> </span><span class="s2">"db-prod-subnet-group"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"SubnetIds"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DatabaseSubnet1"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DatabaseSubnet2"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"Database"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::RDS::DBInstance"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"AllocatedStorage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"AllowMajorVersionUpgrade"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="s2">"DBInstanceClass"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"DatabaseInstanceType"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"DBName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"DatabaseName"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"DBInstanceIdentifier"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"DatabaseName"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"Engine"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MySQL"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"EngineVersion"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"DatabaseEngineVersion"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"DBSubnetGroupName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RDSSubnet"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"MasterUsername"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DatabaseMasterUsername"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"MasterUserPassword"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DatabaseUserPassword"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"MultiAZ"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"VPCSecurityGroups"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DatabaseSG"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"PubliclyAccessible"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DatabasePublicAccess"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"Tags"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Fn::Join"</span><span class="p">:[</span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"db"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ProjectName"</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"VPCName"</span><span class="p">}]]}</span><span class="w"> </span><span class="p">}]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"WebInstance"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::Instance"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"ImageId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WebInstanceImage"</span><span class="p">},</span><span class="w">
            </span><span class="s2">"InstanceType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WebInstanceType"</span><span class="p">},</span><span class="w">
            </span><span class="s2">"KeyName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WebKey"</span><span class="p">},</span><span class="w">
            </span><span class="s2">"BlockDeviceMappings"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"DeviceName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"/dev/sdm"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"Ebs"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"VolumeType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"io1"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"Iops"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"200"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"DeleteOnTermination"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"VolumeSize"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"20"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"DeviceName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"/dev/sdk"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"NoDevice"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
                 </span><span class="p">}</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="s2">"SubnetId"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"WebSubnet1"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="s2">"SecurityGroupIds"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WebSG"</span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"StagingZone"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Route53::HostedZone"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Fn::Join"</span><span class="p">:[</span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ProjectName"</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"VPCName"</span><span class="p">}]]},</span><span class="w">
        </span><span class="s2">"VPCs"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">"VPCId"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="p">},</span><span class="w"> </span><span class="s2">"VPCRegion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eu-west-1"</span><span class="p">}]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"StagingInternetGateway"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::InternetGateway"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Tags"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="s2">"Key"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Fn::Join"</span><span class="p">:[</span><span class="s2">"-"</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"VPCName"</span><span class="p">},</span><span class="w"> </span><span class="s2">"igw"</span><span class="p">]]}}]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"StagingIgwAttach"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::VPCGatewayAttachment"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"InternetGatewayId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StagingInternetGateway"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"VpcId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"StagingRouteTable"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::RouteTable"</span><span class="p">,</span><span class="w">
       </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"VpcId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="p">}</span><span class="w">
       </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"LocalRoute"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::Route"</span><span class="p">,</span><span class="w">
       </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"DestinationCidrBlock"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.0.0/0"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"GatewayId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StagingInternetGateway"</span><span class="p">},</span><span class="w">
          </span><span class="s2">"RouteTableId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StagingRouteTable"</span><span class="p">}</span><span class="w">
       </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"Web1LocalRoute"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::SubnetRouteTableAssociation"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"RouteTableId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StagingRouteTable"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"SubnetId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WebSubnet1"</span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"Db1LocalRoute"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::SubnetRouteTableAssociation"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"RouteTableId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StagingRouteTable"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"SubnetId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DatabaseSubnet1"</span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"Db2LocalRoute"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::SubnetRouteTableAssociation"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"RouteTableId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StagingRouteTable"</span><span class="p">},</span><span class="w">
        </span><span class="s2">"SubnetId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DatabaseSubnet2"</span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseSG"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::SecurityGroup"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"GroupDescription"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Database security groups"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"SecurityGroupIngress"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"IpProtocol"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"tcp"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"FromPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">3306</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ToPort"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"3306"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"SourceSecurityGroupId"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"WebSG"</span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"Tags"</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"db-sg"</span><span class="p">}],</span><span class="w">
        </span><span class="s2">"VpcId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"WebSG"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::SecurityGroup"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"GroupDescription"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Web security groups"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"SecurityGroupIngress"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"IpProtocol"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"tcp"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ToPort"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w">
            </span><span class="s2">"FromPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w">
            </span><span class="s2">"CidrIp"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.0.0/0"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"IpProtocol"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"tcp"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ToPort"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w">
            </span><span class="s2">"FromPort"</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w">
            </span><span class="s2">"CidrIp"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.0.0/0"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"Tags"</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web-sg"</span><span class="p">}],</span><span class="w">
        </span><span class="s2">"VpcId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseRecordSet"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Route53::RecordSet"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="s2">"HostedZoneId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StagingZone"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"Comment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"DNS name for database"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Fn::Join"</span><span class="p">:[</span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"db"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ProjectName"</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"VPCName"</span><span class="p">}]]},</span><span class="w">
         </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"CNAME"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"TTL"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"300"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"ResourceRecords"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
           </span><span class="p">{</span><span class="w"> </span><span class="s2">"Fn::GetAtt"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"Database"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Endpoint.Address"</span><span class="p">]}</span><span class="w">
         </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h2 id="conclusion">Conclusion</h2>
<p>You can load this teamplate in your account and after environment creations you are ready to work with one EC2 instance and one RDS with MySQL 5.6 installed.
You can log into the web interface with key-pair chosen during the creation flow (default ga-eu) and I set default this mysql credential:</p>

<ul>
  <li>user gianarb</li>
  <li>password test1234</li>
</ul>

<p>But you can change it before running this template because they are <code class="highlighter-rouge">Parameters</code>.
This approach in my opinion is very powerful because you can start versioning your infrastructure and you can delete and restore it quickly because if you delete the cloudformation stack it rollbacks all resources, it is very easy!</p>

<h2 id="trick">Trick</h2>

<p>Parameters node create a form into the AWS CloudFormation console to choose a lot of different variable values, for example name of intances or key-pair to log in your EC2.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"Parameters"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"VPCName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"staging"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"VPC name"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"ProjectName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"app"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Project name"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"WebKey"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Default"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"web-key"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Description"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Ssh key to log into the web instances"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<hr class="style-two" />

<p>Resources node contains all elements of your infrastructure, EC2, RDS, VCP.. You can use the parameteters with a simple <code class="highlighter-rouge">Ref Key</code>.
es. <code class="highlighter-rouge">[{"Key": "Name", "Value": "ProjectName"}]</code> describe the name of the specific project into the parameter form.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"Resources"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"Staging"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::VPC"</span><span class="p">,</span><span class="w">
       </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"CidrBlock"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"10.15.0.0/16"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"EnableDnsSupport"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="s2">"EnableDnsHostnames"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="s2">"InstanceTenancy"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"default"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"Tags"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VPCName"</span><span class="p">}}]</span><span class="w">
       </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"DatabaseSubnet1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::EC2::Subnet"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"AvailabilityZone"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"eu-west-1a"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"CidrBlock"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"10.15.1.0/28"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"MapPublicIpOnLaunch"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"VpcId"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"Ref"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Staging"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"Tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s2">"Key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"db-1a"</span><span class="p">}]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<hr class="style-two" />

<p>In your template you can describe VPC and create its subnet. You can also describe the specific resource and you can use it to build another</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">WebSubnet</span><span class="mi">1</span><span class="s2">": {
  "</span><span class="err">Type</span><span class="s2">" : "</span><span class="err">AWS</span><span class="p">::</span><span class="err">EC</span><span class="mi">2</span><span class="p">::</span><span class="err">Subnet</span><span class="s2">",
  "</span><span class="err">Properties</span><span class="s2">" : {
    "</span><span class="err">AvailabilityZone</span><span class="s2">" : "</span><span class="err">eu-west</span><span class="mi">-1</span><span class="err">a</span><span class="s2">",
    "</span><span class="err">CidrBlock</span><span class="s2">" : "</span><span class="mf">10.15</span><span class="err">.</span><span class="mf">0.8</span><span class="err">/</span><span class="mi">28</span><span class="s2">",
    "</span><span class="err">MapPublicIpOnLaunch</span><span class="s2">" : true,
    "</span><span class="err">VpcId</span><span class="s2">": {
      "</span><span class="err">Ref</span><span class="s2">" : "</span><span class="err">Staging</span><span class="s2">"
    },
    "</span><span class="err">Tags</span><span class="s2">" : [{"</span><span class="err">Key</span><span class="s2">": "</span><span class="err">Name</span><span class="s2">", "</span><span class="err">Value</span><span class="s2">": "</span><span class="err">web</span><span class="mi">-1</span><span class="err">a</span><span class="s2">"}]
  }
},</span></code></pre></figure>

<p>In this example I resumed <code class="highlighter-rouge">Staging</code> VPC to build its subnet.</p>

<hr class="style-two" />

<p>This chapter is insteresting because it creates a RecordSet to map a CNAME DNS in your VPC and now in your Web instances you can resolve MYSql host with <code class="highlighter-rouge">db.app.staging</code>.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="s2">"DatabaseRecordSet"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::Route53::RecordSet"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="s2">"HostedZoneId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StagingZone"</span><span class="w">
     </span><span class="p">},</span><span class="w">
     </span><span class="s2">"Comment"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"DNS name for database"</span><span class="p">,</span><span class="w">
     </span><span class="s2">"Name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Fn::Join"</span><span class="p">:[</span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">"db"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ProjectName"</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s2">"Ref"</span><span class="p">:</span><span class="s2">"VPCName"</span><span class="p">}]]},</span><span class="w">
     </span><span class="s2">"Type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"CNAME"</span><span class="p">,</span><span class="w">
     </span><span class="s2">"TTL"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"300"</span><span class="p">,</span><span class="w">
     </span><span class="s2">"ResourceRecords"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
       </span><span class="p">{</span><span class="w"> </span><span class="s2">"Fn::GetAtt"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"Database"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Endpoint.Address"</span><span class="p">]}</span><span class="w">
     </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p><br />
<br />
<br /></p>

<div class="well"><a target="_blank" href="https://twitter.com/EmanueleMinotto">@EmanualeMinotto</a> thanks for trying to fix my bad English</div>

            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/stagin-environment-on-demand-with-aws-cloudformation';
    this.page.identifier = 'https://gianarb.it/blog/stagin-environment-on-demand-with-aws-cloudformation';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
