<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Orbiter an OSS Docker Swarm Autoscaler</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Orbiter is an open source project design to become a cross provider autoscaler. At the moment it works like Zero Configuration Autoscaler for Docker Swarm. It also has a basic implementation to autoscale Digitalocean. This project is designed with InfluxData a company that provides OSS solution like InfluxDB, Kapacitor and Telegraf. We are going to use all this tools to create an autoscaling policy  for your Docker Swarm services.">
    <meta name="keywords" content="docker, influxdb, swarm, orchestration, cloud, kapacitor, chronograf, tick stack, influxdata, monitoring, open source, oss">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/orbiter-docker-swarm-autoscaler">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="Orbiter an OSS Docker Swarm Autoscaler">
    <meta name='twitter:description' content="Orbiter is an open source project design to become a cross provider autoscaler. At the moment it works like Zero Configuration Autoscaler for Docker Swarm. It also has a basic implementation to autoscale Digitalocean. This project is designed with InfluxData a company that provides OSS solution like InfluxDB, Kapacitor and Telegraf. We are going to use all this tools to create an autoscaling policy  for your Docker Swarm services.">

    <meta property="og:title" content="Orbiter an OSS Docker Swarm Autoscaler" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/orbiter-docker-swarm-autoscaler" />
    <meta property="og:description" content="Orbiter is an open source project design to become a cross provider autoscaler. At the moment it works like Zero Configuration Autoscaler for Docker Swarm. It also has a basic implementation to autoscale Digitalocean. This project is designed with InfluxData a company that provides OSS solution like InfluxDB, Kapacitor and Telegraf. We are going to use all this tools to create an autoscaling policy  for your Docker Swarm services." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:image" content="https://gianarb.it/img/swarm.gif" />
    <meta name='twitter:image' content="https://gianarb.it/img/swarm.gif">



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="Orbiter an OSS Docker Swarm Autoscaler">
    <meta name="twitter:description" content="Orbiter is an open source project design to become a cross provider autoscaler. At the moment it works like Zero Configuration Autoscaler for Docker Swarm. It also has a basic implementation to autoscale Digitalocean. This project is designed with InfluxData a company that provides OSS solution like InfluxDB, Kapacitor and Telegraf. We are going to use all this tools to create an autoscaling policy  for your Docker Swarm services.">
    <meta name="twitter:image:src" content="https://gianarb.it/img/swarm.gif">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>Orbiter an OSS Docker Swarm Autoscaler</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">22 Apr 2017 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Eight minute read</span>
 · docker, influxdb, swarm, orchestration, cloud, kapacitor, chronograf, tick stack, influxdata, monitoring, open source, oss</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <iframe width="560" height="315" src="https://www.youtube.com/embed/Q1xfmfML8ok" frameborder="0" allowfullscreen=""></iframe>
<p>My presentation at the Docker HQ in San Francisco.</p>

<h2 id="autoscaling">Autoscaling</h2>
<p>One of the Cloud’s dreams is a nice world when everything magically happen. You
have unlimited resources and you are just going to use what you need and to pay
to you use.
To do what AWS provides a service called autoscaling-group for example. You can
specify some limitation and some expectation about a group of servers and AWS is
matching your expectation for you.
If you are able to make an automatic provision of a node you can use Cloudwatch
to set some alerts. When AWS trigger these alerts the austocaling-group is
creating or removing one or more instance.</p>

<h3 id="lets-try-with-an-example">let’s try with an example</h3>
<p>You have a web service and you know that for 2 hours every day you don’t need 4
EC2 because you have a lot of traffic, you need 10 of them.
You can create an autoscaling group, set some alerts:</p>

<ol>
  <li>When the memory usage is more than 65% for 3 minutes start 3 new servers.</li>
  <li>When the memory usage is less than 30% for 5 minutes stop 2 servers.</li>
</ol>

<p>Just to have an idea. In this way AWS knows what do you and you don’t need to
stay in front of your laptop to wait something happen. You can just do something
funny.</p>

<p>It’s something useful, if you think about a daily magazine, they usually has a
lot of traffic in the beginning of the day when all the people are usually
reading news. At that’s an easy scenario.</p>

<p>But it can also happen than a new shared on reddit or HackerNews is getting a
lot of traffic and the last thing that you are looking for is to go down just
during that spike!</p>

<h3 id="actors">Actors</h3>

<p>There are different actors in this comedy. First of all our cluster needs to be
manageable by outside via API. In this example I am going to use Docker Swarm,
Orbiter supports a basic implementation for DigitalOcean but it still requires
some toning.</p>

<p>You need to have some time series database or analytics platform that can
trigger webhook to trigger orbiter based on some metrics.</p>

<p>We ran a demo with the TICKStack (InfluxDB, Telegraf, and Kapacitor) days ago.
It’s available <a href="https://www.influxdata.com/resources/influxdata-helps-docker-auto-scale-monitoring/?ao_campid=70137000000Jgw7">at this
link</a>.</p>

<p>In the end you need to deploy <a href="https://github.com/gianarb/orbiter">orbiter</a>.</p>

<h3 id="orbiter-design-and-arch">Orbiter, design and arch</h3>

<p>Orbiter is an open source tool designed to be a cross platform autoscaler. It is
in go and it provides a REST API to handle scale requests.</p>

<p>It provides one entrypoint:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-v</span> <span class="nt">-d</span> <span class="s1">'{"direction": true}'</span> <span class="se">\</span>
    http://localhost:8000/handle/infra_scale/docker
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">direction</code> represent how to scale your service, true means up, false means
down.</li>
  <li><code class="highlighter-rouge">/handle/infra_scale/docker</code> identify the autoscaling group.
<code class="highlighter-rouge">infra_scale</code> is the autoscaler name, <code class="highlighter-rouge">docker</code> is the policy name.</li>
</ul>

<p><code class="highlighter-rouge">infra_scale</code> for example contains information about the cluster manager, where
it is, what is it? Docker or Digitalocean or what ever?</p>

<p>The policy describes how an application scale. If you know a bit Docker Swarm
<code class="highlighter-rouge">docker</code> is the name of the service.</p>

<p>Orbiter supports two different boot methods. One is via configuration:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">autoscalers</span><span class="pi">:</span>
  <span class="na">infra_scale</span><span class="pi">:</span>
    <span class="na">provider</span><span class="pi">:</span> <span class="s">swarm</span>
    <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">policies</span><span class="pi">:</span>
      <span class="na">docker</span><span class="pi">:</span>
        <span class="na">up</span><span class="pi">:</span> <span class="s">4</span>
        <span class="na">down</span><span class="pi">:</span> <span class="s">3</span>
</code></pre></div></div>

<p>The second one is actually only supported by Docker Swarm and it’s called
autodetection. In practice when you start orbiter, it’s looking for a Docker
Swarm up and running. If it finds Swarm it’s going to list all the services
deployed and it’s going to manage all the services labeled with <code class="highlighter-rouge">orbiter=true</code>.</p>

<p>By default up and down are set to 1 but you can override them with the label
orbiter.up=3 and orbiter.down=2.</p>

<p>Let’s suppose to have a Docker Swarm cluster with 3 nodes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node <span class="nb">ls
</span>ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS
11btq767ecqhelidu8ah1osfp <span class="k">*</span>  node1     Ready   Active        Leader
ptre8d4bjccqi6ml6z445u0mz    node2     Ready   Active
q5rwi3cej9gc1vqyscwfau640    node3     Ready   Active
</code></pre></div></div>

<p>I deployed a service called <a href="https://github.com/gianarb/micro">gianarb/micro</a>.
It is an open source demo application. There are different versions, I deployed
the version 1.0.0. It only shows the current IP of the container/server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service create <span class="nt">--label</span> <span class="nv">orbiter</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    <span class="nt">--name</span> micro <span class="nt">--replicas</span> 3 <span class="se">\</span>
    <span class="nt">-p</span> 8080:8000 gianarb/micro:1.0.0
</code></pre></div></div>

<p>You can check the number of tasks running with the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service ps micro
ID                  NAME                IMAGE                 NODE
DESIRED STATE       CURRENT STATE            ERROR
         PORTS
         onsqgriv3nel        micro.1             gianarb/micro:1.0.0   node3
         Running             Running 51 seconds ago

         yxtxyder7bs3        micro.2             gianarb/micro:1.0.0   node1
         Running             Running 51 seconds ago

         lyzxxdc00052        micro.3             gianarb/micro:1.0.0   node2
         Running             Running 52 seconds ago

</code></pre></div></div>

<p>At this point you can visit port <code class="highlighter-rouge">8080</code> of your cluster to have a look of the
service but for this demo doesn’t really matter. We are going to start orbiter
and we are going to trigger a scaling policy to simulate a request made by our
monitoring tool.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service create <span class="nt">--name</span> orbiter <span class="se">\</span>
    <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/var/run/docker.sock,destination<span class="o">=</span>/var/run/docker.sock <span class="se">\</span>
    <span class="nt">-p</span> 8000:8000 <span class="nt">--constraint</span> node.role<span class="o">==</span>manager <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">DOCKER_HOST</span><span class="o">=</span>unix:///var/run/docker.sock <span class="se">\</span>
    gianarb/orbiter daemon <span class="nt">--debug</span>
</code></pre></div></div>

<p>I am using Docker to deploy orbiter as service. I am using the Unix Socket to
communicate with Docker Swarm and I am deploying this service into the <code class="highlighter-rouge">manager</code>
because it needs to have write permission to start and stop tasks. This can be
done only into the manager. You can configure orbiter with the variable
<code class="highlighter-rouge">DOCKER_HOST</code> to use REST API. In this way you don’t have this constraint. This
configuration in very easy to show in a demo like this one.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service logs orbiter
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:24:56Z"</span> <span class="nv">level</span><span class="o">=</span>info
<span class="nv">msg</span><span class="o">=</span><span class="s2">"orbiter started"</span>
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:24:56Z"</span> <span class="nv">level</span><span class="o">=</span>debug
<span class="nv">msg</span><span class="o">=</span><span class="s2">"Daemon started in debug mode"</span>
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:24:56Z"</span> <span class="nv">level</span><span class="o">=</span>info
<span class="nv">msg</span><span class="o">=</span><span class="s2">"Starting in auto-detection mode."</span>
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:24:56Z"</span> <span class="nv">level</span><span class="o">=</span>info
<span class="nv">msg</span><span class="o">=</span><span class="s2">"Successfully connected to a Docker daemon"</span>
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:24:56Z"</span> <span class="nv">level</span><span class="o">=</span>debug
<span class="nv">msg</span><span class="o">=</span><span class="s2">"autodetect_swarm/micro added to orbiter. UP 1, DOWN 1"</span>
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:24:56Z"</span> <span class="nv">level</span><span class="o">=</span>info
<span class="nv">msg</span><span class="o">=</span><span class="s2">"API Server run on port :8000"</span>
</code></pre></div></div>
<p>As you can see into the logs the API are running on port 8000 and orbiter
already detected a service called <code class="highlighter-rouge">micro</code>, the one that we deployed before and
it auto-created a autoscaling group called <code class="highlighter-rouge">autodetection_swarm/micro</code>.
This is the unique name that we can use when we trigger our scale request.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-d</span> <span class="s1">'{"direction": true}'</span> <span class="nt">-v</span>
http://10.0.57.3:8000/handle/autodetect_swarm/micro
<span class="k">*</span>   Trying 10.0.57.3...
<span class="k">*</span> TCP_NODELAY <span class="nb">set</span>
<span class="k">*</span> Connected to 10.0.57.3 <span class="o">(</span>10.0.57.3<span class="o">)</span> port 8000 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> POST /handle/autodetect_swarm/micro HTTP/1.1
<span class="o">&gt;</span> Host: 10.0.57.3:8000
<span class="o">&gt;</span> User-Agent: curl/7.52.1
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> Content-Length: 19
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
<span class="k">*</span> upload completely sent off: 19 out of 19 bytes
&lt; HTTP/1.1 200 OK
&lt; Content-Type: application/json
&lt; Date: Tue, 18 Apr 2017 09:30:35 GMT
&lt; Content-Length: 0
&lt;
<span class="k">*</span> Curl_http_done: called premature <span class="o">==</span> 0
<span class="k">*</span> Connection <span class="c">#0 to host 10.0.57.3 left intact</span>
</code></pre></div></div>

<p>With that cURL I simulated a scale request and as you can see in the log above
orbiter detected the request and it scaled up 1 task for our service called
<code class="highlighter-rouge">macro</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service logs orbiter
orbiter.1.zop1qkwa1qxy@node1    | POST /handle/autodetect_swarm/micro HTTP/1.1
orbiter.1.zop1qkwa1qxy@node1    | Host: 10.0.57.3:8000
orbiter.1.zop1qkwa1qxy@node1    | Accept: <span class="k">*</span>/<span class="k">*</span>
orbiter.1.zop1qkwa1qxy@node1    | Content-Length: 19
orbiter.1.zop1qkwa1qxy@node1    | Content-Type:
application/x-www-form-urlencoded
orbiter.1.zop1qkwa1qxy@node1    | User-Agent: curl/7.52.1
orbiter.1.zop1qkwa1qxy@node1    |
orbiter.1.zop1qkwa1qxy@node1    | <span class="o">{</span><span class="s2">"direction"</span>: <span class="nb">true</span><span class="o">}</span>
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:30:35Z"</span> <span class="nv">level</span><span class="o">=</span>info
<span class="nv">msg</span><span class="o">=</span><span class="s2">"Received a new request to scale up micro with 1 task."</span> direc
<span class="nv">tion</span><span class="o">=</span><span class="nb">true </span><span class="nv">service</span><span class="o">=</span>micro
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:30:35Z"</span> <span class="nv">level</span><span class="o">=</span>debug
<span class="nv">msg</span><span class="o">=</span><span class="s2">"Service micro scaled from 3 to 4"</span> <span class="nv">provider</span><span class="o">=</span>swarm
orbiter.1.zop1qkwa1qxy@node1    | <span class="nb">time</span><span class="o">=</span><span class="s2">"2017-04-18T09:30:35Z"</span> <span class="nv">level</span><span class="o">=</span>info
<span class="nv">msg</span><span class="o">=</span><span class="s2">"Service micro scaled up."</span> <span class="nv">direction</span><span class="o">=</span><span class="nb">true </span><span class="nv">service</span><span class="o">=</span>micro
</code></pre></div></div>

<p>We can verify the current number of tasks that are running for <code class="highlighter-rouge">micro</code> and we
can see that it’s not 3 as before but 4.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service <span class="nb">ls
</span>ID                  NAME                MODE                REPLICAS
IMAGE
azi8zyeor5eb        micro               replicated          4/4
gianarb/micro:1.0.0
ezklgb6uak8b        orbiter             replicated          1/1
gianarb/orbiter:latest
</code></pre></div></div>

<p>This project is open source on
<a href="https://github.com/gianarb/orbiter">github.com/gianarb/orbiter</a> you can have a look on
it, try and leave some feedback or request if you need something different.</p>

<p>PR are also open if you are working with a different cluster manager or with a
different provider, add a new one is very easy. It’s just a new interface to
implement.</p>


            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/orbiter-docker-swarm-autoscaler';
    this.page.identifier = 'https://gianarb.it/blog/orbiter-docker-swarm-autoscaler';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
