<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Continuous profiling in Go with Profefe</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Taking a snapshot at the right time is nearly impossible. A very easy way to fix this issue is to have a continuous profiling infrastructure that gives you enough confidence of having a profile at the time you need it.">
    <meta name="keywords" content="golang, pprof, profefe">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/go-continuous-profiling-profefe">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="Continuous profiling in Go with Profefe">
    <meta name='twitter:description' content="Taking a snapshot at the right time is nearly impossible. A very easy way to fix this issue is to have a continuous profiling infrastructure that gives you enough confidence of having a profile at the time you need it.">

    <meta property="og:title" content="Continuous profiling in Go with Profefe" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/go-continuous-profiling-profefe" />
    <meta property="og:description" content="Taking a snapshot at the right time is nearly impossible. A very easy way to fix this issue is to have a continuous profiling infrastructure that gives you enough confidence of having a profile at the time you need it." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:image" content="https://gianarb.it/img/profefe.png" />
    <meta name='twitter:image' content="https://gianarb.it/img/profefe.png">



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="Continuous profiling in Go with Profefe">
    <meta name="twitter:description" content="Taking a snapshot at the right time is nearly impossible. A very easy way to fix this issue is to have a continuous profiling infrastructure that gives you enough confidence of having a profile at the time you need it.">
    <meta name="twitter:image:src" content="https://gianarb.it/img/profefe.png">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>Continuous profiling in Go with Profefe</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">03 Jan 2020 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Three minute read</span>
 · golang, pprof, profefe</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <p>There are a lot of articles about profiling in Go. Julia Evans for examples
wrote <a href="https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/">“Profiling Go programs with
pprof”</a> and I rely on
it when I do not remember how to properly use pprof.</p>

<p>Rakyll wrote <a href="https://rakyll.org/custom-profiles/">“Custom pprof profiles”</a>.</p>

<p><code class="highlighter-rouge">pprof</code> is a powerful tool provided by Go that helps any developer to figure out
what is going in the Go runtime. When you see a spike in memory in your running
container the next question is who is using all that memory. Profiles tell you
the answer.</p>

<p>But they need to be grabbed at the right time. The unique way to have a profile when
you need it is by taking them continuously. Based on your application you should
be able to specify how often you have to gather a profile.</p>

<p>This requires a proper infrastructure that we can call “Continuous profiles
infrastructure”. It is made of collectors, repositories and you need an API to
store, retrieve and query those profiles.</p>

<p>When we had to set it up at InfluxData we started to craft our own one until I
saw <a href="https://github.com/profefe/profefe"><code class="highlighter-rouge">profefe</code></a> on GitHub. What I love about
the project is its clear scope. It is a repository for profiles. You can push
them in Profefe and it provides an API to get them out, it servers the profiles in a
way that make them easy to visualize directly with <code class="highlighter-rouge">go tool pprof</code>, you can even
merge them together and so on. It also have a clear interface that helps you to
implement your own storage.</p>

<p>The project
<a href="https://github.com/profefe/profefe/blob/master/README.md">README.md</a> well
explains how it works but I am going to summarize the most important actions in
this article.</p>

<h2 id="getting-started">Getting Started</h2>

<p>There is a docker image that you can run with the command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 10100:10100 profefe/profefe
</code></pre></div></div>

<p>You can push a profile in profefe:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -X POST \
    "http://localhost:10100/api/0/profiles?service=apid&amp;type=cpu" \
    --data-binary @pprof.profefe.samples.cpu.001.pb.gz

{"code":200,"body":{"id":"bo51acqs8snb9srq3p10","type":"cpu","service":"apid","created_at":"2019-12-30T15:18:11.361815452Z"}}
</code></pre></div></div>

<p>You can retrieve it directly via its ID:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ go tool pprof http://localhost:10100/api/0/profiles/bo51acqs8snb9srq3p10

Fetching profile over HTTP from http://localhost:10100/api/0/profiles/bo51acqs8snb9srq3p10
Saved profile in /home/gianarb/pprof/pprof.profefe.samples.cpu.002.pb.gz
File: profefe
Type: cpu
Time: Dec 23, 2019 at 4:06pm (CET)
Duration: 30s, Total samples = 0
</code></pre></div></div>

<p>There is a lot more you can do, when pushing a profile you can set key value
pairs called <code class="highlighter-rouge">labels</code> and they can be used to query a portion of the profiles.</p>

<p>You can use <code class="highlighter-rouge">env=prod|test|dev</code> or <code class="highlighter-rouge">region=us|eu</code> and so on.</p>

<p>Retrieving a profile only via ID it’s not the unique way to visualize it.
Profefe merges together profiles from the same type in a specific time range:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /api/0/profiles/merge?service=&lt;service&gt;&amp;type=&lt;type&gt;&amp;from=&lt;created_from&gt;&amp;to=&lt;created_to&gt;&amp;labels=&lt;key=value,key=value&gt;
</code></pre></div></div>

<p>It returns the raw compressed binary, it is compatible with <code class="highlighter-rouge">go tool pprof</code> as
well as the single profile by id.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I didn’t develop profefe, <a href="https://github.com/narqo">Vladimir (@narqo)</a> is the
maintainer, I like it and how it is coded. I think it solves a very common
issue. He wrote a detailed post about his project
<a href="https://medium.com/@tvii/continuous-profiling-and-go-6c0ab4d2504b">“Continuous Profiling and Go”</a></p>

<blockquote>
  <p>Wouldn’t it be great if we could go back in time to the point when the issue
happened in production and collect all runtime profiles. Unfortunately, to my
knowledge, we can’t do that.</p>
</blockquote>

<p>One of my colleague Chris Goller wrote a self contained AWS S3 implementation
that is now submitted as PR. We are running it since a couple of weeks now. It
is hard to onboard developers in a new tool, even more during Christmas but the
API layers makes it very comfortable and friendly to use. Next article will be
about what we did to get it running in Kubernetes continuously profiling our
containers.</p>

            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/go-continuous-profiling-profefe';
    this.page.identifier = 'https://gianarb.it/blog/go-continuous-profiling-profefe';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
