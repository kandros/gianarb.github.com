<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Cloud Native Intranet with Kubernetes, CoreDNS and OpenVPN</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Designing an architecture the network should be a top priority because it is very hard to change moving forward. Even in a cloud environment running on Kubernetes the situation doesn't change. Security and networking are hard pattern hard to inject in old projects. In this talk I will share a practical idea about how to start in the best way with OpenVPN and private DNS in a Kubernetes cluster in order to build your own intranet.">
    <meta name="keywords" content="devops, kubernetes, security, network, intranet, dns, vpn, openvpn, coredns">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/cloud-native-intranet">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="Cloud Native Intranet with Kubernetes, CoreDNS and OpenVPN">
    <meta name='twitter:description' content="Designing an architecture the network should be a top priority because it is very hard to change moving forward. Even in a cloud environment running on Kubernetes the situation doesn't change. Security and networking are hard pattern hard to inject in old projects. In this talk I will share a practical idea about how to start in the best way with OpenVPN and private DNS in a Kubernetes cluster in order to build your own intranet.">

    <meta property="og:title" content="Cloud Native Intranet with Kubernetes, CoreDNS and OpenVPN" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/cloud-native-intranet" />
    <meta property="og:description" content="Designing an architecture the network should be a top priority because it is very hard to change moving forward. Even in a cloud environment running on Kubernetes the situation doesn't change. Security and networking are hard pattern hard to inject in old projects. In this talk I will share a practical idea about how to start in the best way with OpenVPN and private DNS in a Kubernetes cluster in order to build your own intranet." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:image" content="https://gianarb.it/img/kubernetes.png" />
    <meta name='twitter:image' content="https://gianarb.it/img/kubernetes.png">



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="Cloud Native Intranet with Kubernetes, CoreDNS and OpenVPN">
    <meta name="twitter:description" content="Designing an architecture the network should be a top priority because it is very hard to change moving forward. Even in a cloud environment running on Kubernetes the situation doesn't change. Security and networking are hard pattern hard to inject in old projects. In this talk I will share a practical idea about how to start in the best way with OpenVPN and private DNS in a Kubernetes cluster in order to build your own intranet.">
    <meta name="twitter:image:src" content="https://gianarb.it/img/kubernetes.png">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>Cloud Native Intranet with Kubernetes, CoreDNS and OpenVPN</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">29 May 2018 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Six minute read</span>
 · devops, kubernetes, security, network, intranet, dns, vpn, openvpn, coredns</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <p>This article has a marketing and buzzword oriented title. I know.</p>

<p>Let me introduce you to what I am going to speak with you here with better
worlds: VPN, private, DNS, kubernetes, security.</p>

<p>I hope we all agree that VPN should be a must-have when you set up an
infrastructure. It doesn’t matter what you are doing, how many people are
working with you.</p>

<p>When you design a new system usually you need to expose to the public only some
service over HTTP and HTTPS all the rest: Jenkins, monitoring tools,
dashboards, log management should be locked-down and accessible just in a
private network. An intranet.</p>

<blockquote>
  <p>An intranet is a private network accessible only to an organization’s staff.
Often, a wide range of information and services are available on an
organization’s internal intranet that is unavailable to the public, unlike the
Internet.</p>
</blockquote>

<p>All these concepts apply to “Cloud Native” ecosystem as well.</p>

<p>Kubernetes has a powerful dashboard and CTL that you can use to interact with
the API. That API doesn’t need to be publicly exposed, and to use the CLI from
your laptop, you should set up a VPN.</p>

<h2 id="openvpn">OpenVPN</h2>
<p>Usually, I configure an OpenVPN using the image
<a href="https://hub.docker.com/r/kylemanna/openvpn/">kylemanna/openvpn</a> available on
Docker Hub. It is straightforward to apply, and it offers a set of utilities
around user creation and certification management.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">openvpn</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">openvpn</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">openvpn</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">openvpn</span>
    <span class="na">nodePort</span><span class="pi">:</span> <span class="s">1194</span>
    <span class="na">port</span><span class="pi">:</span> <span class="s">1194</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">1194</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">openvpn</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">openvpn</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">openvpn"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">openvpn</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">openvpn</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">openvpn</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">role</span><span class="pi">:</span> <span class="s">vpn</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">openvpn</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/kylemanna/openvpn</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/etc/openvpn/setup/configure.sh"</span><span class="pi">]</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">VPN_HOSTNAME</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">vpn-hostname</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">hostname</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">VPN_DNS</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">vpn-hostname</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">dns</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">1194</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">openvpn</span>
          <span class="na">securityContext</span><span class="pi">:</span>
            <span class="na">capabilities</span><span class="pi">:</span>
              <span class="na">add</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">NET_ADMIN</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/openvpn/setup</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">openvpn</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/openvpn/certs</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">certs</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">openvpn</span>
          <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">openvpn</span>
            <span class="na">defaultMode</span><span class="pi">:</span> <span class="s">0755</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">certs</span>
          <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
            <span class="na">claimName</span><span class="pi">:</span> <span class="s">openvpncerts</span>
</code></pre></div></div>
<p>I put the persistentVolumeClaim to remember you to store in a persisted and
safe place (and you should backup them too) the certificates used and generated
by the VPN <code class="highlighter-rouge">/etc/openvpn/certs</code>.</p>

<p>I won’t write more about this topic; we are all excellent yaml developers!</p>

<p>How to create users, configuration and so on is a well knows topic that you can
easily <a href="https://openvpn.net/index.php/open-source/documentation.html">find in the OpenVPN’s
documentation</a>.</p>

<p>I don’t know if you realized that, but this VPN runs inside a Kubernetes
Cluster, so well configurated allow us to reach pods via a private network and
a bonus point also via kubedns to ping services, pods and all the other
resources registered to it.</p>

<p>To do that OpenVPN server can be configured to push kubedns to the client:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dhcp-option DNS &lt;kube-dns-ip&gt;
</code></pre></div></div>
<p>Something with learned is that if you are using Linux the
NetworkManager-OpenVPN plugin pushes the DNS correctly, but the OpenVPN cli
tool doesn’t if you are using the last one you need to set it up in another
way.</p>

<p>Tips: You can take the <code class="highlighter-rouge">&lt;kube-dns-ip&gt;</code> doing <code class="highlighter-rouge">cat /etc/resolv.conf</code> from inside a pod.</p>

<h2 id="dns">DNS</h2>
<p>Push the KubeDNS or the DNS used by kubernetes is not enough to have a complete
intranet. You should be able to set up a custom domain to have friendly or
short URL.</p>

<p>You can take two different directions. KubeDNS can have static
record configured, but some person is not happy to touch or customize too much
the KubeDNS because Kubernetes itself use it and if you mess it up all it can
be a problem.</p>

<p>A possible solution is to deploy another DNS like CoreDNS and
configures it to resolve KubeDNS as a fallback. In this way, you will be free
to register custom LTDs and records. Kubernetes is going to use KubeDNS as
usual, and if you mess up CoreDNS, only a fraction of your system will blow
out.</p>

<p>Naturally to resolve your custom domains from the VPN you need to push
the CoreDNS ip and not the one used by Kubernetes.</p>

<p>If two DNSs are too much take the option one or from Kubernetes 1.10 you can
use CoreDNS as kubernetes DNS so it is a bit more flexible and you can use only
that one if you are brave enough.</p>

<p>I suggested CoreDNS because it supports records configuration via
<a href="https://github.com/coredns/coredns/tree/master/plugin/etcd">etcd</a>. Here an
example of Corefile:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. {
      errors
      etcd *.myinternal {
          stubzones
          path /skydns
          entrypoint  http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379
          upstream /etc/resolv.conf
      }
      proxy . /etc/resolv.conf
}
</code></pre></div></div>
<p>Running this configuration inside a pod automatically fallback to kubedns (that
automatically fallback to the one configured to reach internet). Because of
<code class="highlighter-rouge">upstream</code> point to <code class="highlighter-rouge">resolv.conf</code> that inside a pod contains kubedns.</p>

<h2 id="benefits">Benefits</h2>
<p>Resolve Kubernetes DNS record from your local environment is very comfortable
to build a shared or dynamic development environment for you and your
colleagues.</p>

<p>You can set up per-developer namespaces that they can use to
deploy services reachable from the program that they are writing. Or you can
deploy your application, and another person connected to the VPN will be able
to use it.</p>

            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/cloud-native-intranet';
    this.page.identifier = 'https://gianarb.it/blog/cloud-native-intranet';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
