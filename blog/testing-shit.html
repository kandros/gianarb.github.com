<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>I don't give a shit about testing</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="This is all about how I approach testing in development. TDD, DDD, unit test, integration test. It should make my development faster and my code easy to maintain. We have a lot of different techniques because we need to be good on picking the right one.">
    <meta name="keywords" content="testing, development, golang, container">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/testing-shit">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta name='twitter:card' content='summary_large_image'>
    <meta name='twitter:title' content="I don't give a shit about testing">
    <meta name='twitter:description' content="This is all about how I approach testing in development. TDD, DDD, unit test, integration test. It should make my development faster and my code easy to maintain. We have a lot of different techniques because we need to be good on picking the right one.">

    <meta property="og:title" content="I don't give a shit about testing" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/testing-shit" />
    <meta property="og:description" content="This is all about how I approach testing in development. TDD, DDD, unit test, integration test. It should make my development faster and my code easy to maintain. We have a lot of different techniques because we need to be good on picking the right one." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />

    <meta property="og:image" content="https://gianarb.it/img/laziness.jpg" />
    <meta name='twitter:image' content="https://gianarb.it/img/laziness.jpg">



    <meta property="twitter:account_id" content="129952408" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gianarb">
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:title" content="I don't give a shit about testing">
    <meta name="twitter:description" content="This is all about how I approach testing in development. TDD, DDD, unit test, integration test. It should make my development faster and my code easy to maintain. We have a lot of different techniques because we need to be good on picking the right one.">
    <meta name="twitter:image:src" content="https://gianarb.it/img/laziness.jpg">
    <meta name="twitter:image:width" content="500">
    <meta name="twitter:image:height" content="500">
    <meta name="twitter:domain" content="gianarb.it">

    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" rel="stylesheet">

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark" role="navigation">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-brand" href="#">
        <a href="/" class="nav-link">
          <img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt="">
        </a>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li><a class="nav-link" href="/">Home</a></li>
          <li><a class="nav-link" href="/blog.html">Blog</a></li>
          <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
          </li>
        </ul>

      </div>

    </div>
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>I don't give a shit about testing</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">29 Mar 2018 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Eight minute read</span>
 · testing, development, golang, container</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="addthis_sharing_toolbox"></div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <p>That’s what I learned during my experience as a developer. Doesn’t matter
which languages you end up working if you are making HTTP API or things like
that you don’t have an excuse. Write tests make your development faster, and it will
drastically improve maintainability of your project.</p>

<p>In this post, I would like to tell you how I approach testing particularly in
Go obviously.</p>

<p>First of all, when you create a new file, you should write its <code class="highlighter-rouge">_test.go</code> child.
It’s hard to tell you who should be the child of who. Sometimes I start
to write everything inside a test function, just because run the actual test is faster
compared with compile, run the binary, trigger the right entry point and so on.
When I am satisfied, I move the
code to a function, and I leave the assertions I wrote as a new test. <strong>Pretty good</strong>.</p>

<blockquote>
  <p>I don’t give a shit about automated testing. I write tests.</p>
</blockquote>

<p>I use <a href="https://github.com/fatih/vim-go"><code class="highlighter-rouge">vim-go</code></a> and <code class="highlighter-rouge">:GoTestFunc</code> is probably
the most used shortcut during my day to day job.</p>

<p>When I can choose I don’t use assertion libraries, the <code class="highlighter-rouge">testing</code> package is
enough for me and dependency management in go is a pain, so fewer things I vendor
better I feel about myself.</p>

<p><img src="/img/laziness.jpg" class="img-fluid" /></p>

<p>I use fixtures, but I don’t like them. I prefer to write more small tests than complicated fixtures.</p>

<p>A single test for me is more descriptive, and I don’t mind to write redundant code, I can always refactor it later or move it some helper function. A complicated fixture will be hard to maintain.
The name of the function is an excellent way to describe what you are covering in your test and the function itself
creates a beautiful block that improves readability.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">TestCarComposition</span><span class="p">(</span><span class="n">t</span><span class="x"> </span><span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">fixtures</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="n">car</span><span class="o">.</span><span class="n">Composition</span><span class="p">{</span><span class="x">
        </span><span class="p">{</span><span class="s">"blue"</span><span class="p">,</span><span class="x"> </span><span class="s">"europe"</span><span class="p">,</span><span class="x"> </span><span class="m">1</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="s">"2011-12-05"</span><span class="p">,</span><span class="x"> </span><span class="s">"ford"</span><span class="p">},</span><span class="x">
        </span><span class="p">{</span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="m">35</span><span class="p">,</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="s">"ford"</span><span class="p">},</span><span class="x">
        </span><span class="p">{</span><span class="s">"red"</span><span class="p">,</span><span class="x"> </span><span class="s">"usa"</span><span class="p">,</span><span class="x"> </span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="s">"fiat"</span><span class="p">},</span><span class="x">
        </span><span class="p">{</span><span class="s">"white"</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="m">35</span><span class="p">,</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="s">"kia"</span><span class="p">},</span><span class="x">
        </span><span class="p">{</span><span class="s">"orange"</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="m">1</span><span class="p">,</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="s">"2010-05-12"</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">},</span><span class="x">
        </span><span class="p">{</span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="s">"ford"</span><span class="p">},</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>Bonus point, as you can see fixtures are sad to read!</p>

<p>Even unit vs. integration vs. function is a very annoying discussion. Don’t tell me
about TDD, BDD, CCC, DDD things. I don’t care they are all amazing as
soon as they can make my development simple.</p>

<p>So, CDD is probably my best test methodology: <strong>Comfort driven development</strong>.</p>

<p>Usually when I am writing a computing function when it elaborates maps, strings,
files without using too many external resources I start from unit test, because
it makes iteration faster as I told before. And it won’t require too many mocks.
I don’t like mocks.</p>

<h2 id="lets-discuss-mocks">Let’s discuss mocks</h2>
<p>Mocks are a pain; you end up to be bored when you write mocks, they won’t fail when it’s useful for you to see an error and they will fail when you don’t care.
So comfort looks very far from mocks!</p>

<p>When mocks becomes too complicated, and I can write another kind of tests I go with that solution. Maybe integration or I will try to write the simple mock
possible, sometimes even the entire web server can be a valuable solution:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">TestInfluxDBSdkGetTheRightValues</span><span class="p">(</span><span class="n">ti</span><span class="x"> </span><span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">ts</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">httptest</span><span class="o">.</span><span class="n">NewServer</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">data</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">influxdb</span><span class="o">.</span><span class="n">Response</span><span class="p">{</span><span class="x">
            </span><span class="n">Results</span><span class="o">:</span><span class="x"> </span><span class="p">[]</span><span class="n">influxdb</span><span class="o">.</span><span class="n">Result</span><span class="p">{</span><span class="x">
                </span><span class="p">{</span><span class="x">
                    </span><span class="n">Series</span><span class="o">:</span><span class="x"> </span><span class="p">[]</span><span class="n">influxdbModels</span><span class="o">.</span><span class="n">Row</span><span class="p">{},</span><span class="x">
                </span><span class="p">},</span><span class="x">
            </span><span class="p">},</span><span class="x">
        </span><span class="p">}</span><span class="x">
        </span><span class="n">w</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span><span class="x"> </span><span class="s">"application/json"</span><span class="p">)</span><span class="x">
        </span><span class="n">w</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">)</span><span class="x">
        </span><span class="n">_</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">NewEncoder</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="x">
    </span><span class="p">}))</span><span class="x">
    </span><span class="k">defer</span><span class="x"> </span><span class="n">ts</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">

    </span><span class="n">config</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">influxdb</span><span class="o">.</span><span class="n">HTTPConfig</span><span class="p">{</span><span class="n">Addr</span><span class="o">:</span><span class="x"> </span><span class="n">ts</span><span class="o">.</span><span class="n">URL</span><span class="p">}</span><span class="x">
    </span><span class="n">client</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">influxdb</span><span class="o">.</span><span class="n">NewHTTPClient</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="x">
    </span><span class="k">defer</span><span class="x"> </span><span class="n">client</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">

    </span><span class="c">// Whatever you need to check</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>
<p>You need to play carefully; these tests are slower and more expensive in
resources.
But I like the idea to take the faster solution when I am developing; you can
come back on your tests later when the feature is more stable and better
designed. Write tests should not slow me down too much, I am looking for a way
to write the implementation and the test fasts to iterate on both of them other than waste time making everything perfect. Nothing will be forever; nothing will be complete in programming, so design your environment to be easy to change.</p>

<h2 id="integration-tests">Integration tests</h2>
<p>I am a CLI kind of person, so I often send HTTP requests via cURL.
Docker is very easy from day one to start and stop your application,
cleaning databases and so on.</p>

<p><a href="https://github.com/sstephenson/bats"><code class="highlighter-rouge">bats</code></a> combines these two sentences. It is an automation test framework for
bash. It is very simple to setup, and it allows me to copy paste some cURL, and
with jq, you can make the checks you need over your JSON response.</p>

<p>An integration test suite made with bats looks like that:</p>

<ol>
  <li>An “init” file in bash where you can run setup and teardown function before and after every test. Usually, you can you that functions to spin up and down the
containers that you need to tests, this is the one that I wrote for this
example</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="k">function </span>setup<span class="o">()</span> <span class="o">{</span>
  <span class="nv">teardownCallback</span><span class="o">=</span><span class="k">$(</span>init<span class="k">)</span>
<span class="o">}</span>

<span class="k">function </span>teardown<span class="o">()</span> <span class="o">{</span>
  <span class="nb">eval</span> <span class="nv">$teardownCallback</span>
<span class="o">}</span>

<span class="k">function </span>getHost<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"http://localhost"</span>
<span class="o">}</span>

<span class="k">function </span>init <span class="o">{</span>
  <span class="nv">executionID</span><span class="o">=</span><span class="k">$(</span><span class="nb">cat</span> /dev/urandom | tr <span class="nt">-dc</span> <span class="s1">'a-zA-Z0-9'</span> | fold <span class="nt">-w</span> 7 | head <span class="nt">-n</span> 1<span class="k">)</span>
  <span class="nv">containerLabels</span><span class="o">=</span><span class="s2">"exec=</span><span class="k">${</span><span class="nv">executionID</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">$(</span>docker run <span class="nt">-d</span> <span class="nt">-l</span> <span class="nv">$containerLabels</span> <span class="nt">-p</span> 80:80 nginx<span class="k">)</span>
  <span class="nb">echo</span> <span class="s2">"docker ps -aq -f 'label=</span><span class="k">${</span><span class="nv">containerLabels</span><span class="k">}</span><span class="s2">' | xargs docker rm -f"</span>
<span class="o">}</span>
</code></pre></div></div>
<ol>
  <li>You have a set of <code class="highlighter-rouge">.bats</code> files with the various scenarios, I wrote one to
check if the status code 200 for the nginx home</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bats</span>

load utils

@test <span class="s2">"Nginx home return 200"</span> <span class="o">{</span>
      <span class="nv">statusCode</span><span class="o">=</span><span class="k">$(</span>curl <span class="nt">-I</span> <span class="nt">-X</span> GET <span class="s2">"</span><span class="k">$(</span>getHost<span class="k">)</span><span class="s2">"</span> 2&gt;/dev/null | head <span class="nt">-n</span> 1 | cut
      <span class="nt">-d</span><span class="s1">$' '</span> <span class="nt">-f2</span><span class="k">)</span>
        <span class="o">[</span> <span class="nv">$statusCode</span> <span class="nt">-eq</span> 200 <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>What you are running is a <code class="highlighter-rouge">bats</code> test to check that <code class="highlighter-rouge">nginx:latest</code> is serving the right page.
Your use case will be ten times more complicated.</p>

<p>Another reason to take this approach is about bash itself. If you are not a bash
expert, you will probably end up to write straightforward tests, cURL, grep,
regex and some pipes. Nothing more.</p>

<p>And you won’t use any code that runs your application. It’s important to avoid
weird buggy tests.</p>

<h2 id="developer-happiness">developer happiness</h2>
<p>Tests are a methodology to decrease the cost of maintenance and to improve your
ability to write code.</p>

<p>It should not be a fashion way to show how good you are as a developer. You will
be a good developer as a side effect.</p>

<p>I look at all the different way to tests my code as a tool set, AI is becoming
very smart. So we need to be less “server” and more human been. 100% coverage
for unit tests looks a lot like something that a server can do. Pick the right
method based on your feeling.</p>

<script>
$(document).ready(function() {
	$('body').css("background", "#F5F3E6");
});
</script>


            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div id="disqus_thread"></div>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
        </div>

    </div>
</div>

<script>
var disqus_config = function () {
    this.page.url = 'https://gianarb.it/blog/testing-shit';
    this.page.identifier = 'https://gianarb.it/blog/testing-shit';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://gianarbdeveloper.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update December 22, 2020 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="https://twitch.tv/gianarb" target="_blank">twitch.tv/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/dockerfile.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/go.min.js"></script>
        <script src="/js/custom.js"></script>

        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
